<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#F7941D">
    <title>ç®¡ç†å“¡å ±è¡¨ - æ½®æ¬£å°å¹«æ‰‹</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .report-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .report-card h3 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: #333;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            text-align: center;
        }
        .stat-item {
            padding: 12px 8px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .stat-item.highlight {
            background: linear-gradient(135deg, #1DB446 0%, #17a03d 100%);
            color: white;
        }
        .stat-item.warning {
            background: linear-gradient(135deg, #FF6B35 0%, #e55a2b 100%);
            color: white;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            display: block;
        }
        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 4px;
        }
        .staff-list {
            margin-top: 12px;
        }
        .staff-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .staff-item:last-child {
            border-bottom: none;
        }
        .staff-name {
            font-weight: bold;
            font-size: 15px;
        }
        .staff-stats {
            display: flex;
            gap: 12px;
            font-size: 13px;
            color: #666;
        }
        .staff-stats span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .sell-rate {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        .sell-rate.good { background: #d4edda; color: #155724; }
        .sell-rate.warning { background: #fff3cd; color: #856404; }
        .sell-rate.bad { background: #f8d7da; color: #721c24; }
        .product-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .product-item.attention {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .product-name {
            font-weight: 500;
            font-size: 14px;
        }
        .product-stats {
            display: flex;
            gap: 12px;
            font-size: 13px;
        }
        .log-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .log-time {
            font-size: 12px;
            color: #999;
            margin-bottom: 4px;
        }
        .log-action {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 8px;
        }
        .log-action.sold { background: #d4edda; color: #155724; }
        .log-action.disposed { background: #f8d7da; color: #721c24; }
        .log-action.register { background: #cce5ff; color: #004085; }
        .period-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .period-tab {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 20px;
            background: white;
            font-size: 13px;
            cursor: pointer;
        }
        .period-tab.active {
            background: #F7941D;
            color: white;
            border-color: #F7941D;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <!-- 7-11 é¢¨æ ¼ Header -->
    <header class="header">
        <div class="header-stripes">
            <div class="stripe-orange"></div>
            <div class="stripe-green"></div>
            <div class="stripe-red"></div>
        </div>
        <div class="header-content">
            <span class="header-back" onclick="location.href='/'">â†</span>
            <h1>ğŸ“Š ç®¡ç†å“¡å ±è¡¨</h1>
            <p class="subtitle">åº—å“¡æ“ä½œè¿½è¹¤ Ã— é€²è²¨åˆ†æ</p>
        </div>
    </header>

    <div class="container">
        <!-- ç¸½è¦½å¡ç‰‡ -->
        <div class="report-card">
            <h3>ğŸ“ˆ ä»Šæ—¥ç¸½è¦½</h3>
            <div class="stat-grid" id="todayStats">
                <div class="stat-item">
                    <span class="stat-number">-</span>
                    <span class="stat-label">å·²å”®å‡º</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">-</span>
                    <span class="stat-label">å·²ä¸‹æ¶</span>
                </div>
                <div class="stat-item highlight">
                    <span class="stat-number">-</span>
                    <span class="stat-label">å”®å‡ºç‡</span>
                </div>
            </div>
        </div>

        <!-- æœ¬é€±çµ±è¨ˆ -->
        <div class="report-card">
            <h3>ğŸ“… æœ¬é€±çµ±è¨ˆ</h3>
            <div class="stat-grid" id="weekStats">
                <div class="stat-item">
                    <span class="stat-number">-</span>
                    <span class="stat-label">å·²å”®å‡º</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">-</span>
                    <span class="stat-label">å·²ä¸‹æ¶</span>
                </div>
                <div class="stat-item highlight">
                    <span class="stat-number">-</span>
                    <span class="stat-label">å”®å‡ºç‡</span>
                </div>
            </div>
        </div>

        <!-- åº—å“¡çµ±è¨ˆ -->
        <div class="report-card">
            <h3>ğŸ‘¥ åº—å“¡æ“ä½œçµ±è¨ˆ</h3>
            <div class="period-tabs">
                <button class="period-tab active" data-period="today">ä»Šå¤©</button>
                <button class="period-tab" data-period="week">æœ¬é€±</button>
                <button class="period-tab" data-period="month">æœ¬æœˆ</button>
            </div>
            <div class="staff-list" id="staffList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- å•†å“å ±å»¢åˆ†æ -->
        <div class="report-card">
            <h3>ğŸ“¦ å•†å“å ±å»¢åˆ†æ</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
                âš ï¸ é»ƒè‰²æ¨™è¨˜ = å ±å»¢ç‡ > 50%ï¼Œå»ºè­°æ¸›å°‘é€²è²¨
            </p>
            <div id="productList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- æœ€è¿‘æ“ä½œè¨˜éŒ„ -->
        <div class="report-card">
            <h3>ğŸ“‹ æœ€è¿‘æ“ä½œè¨˜éŒ„</h3>
            <div id="logList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- ç‰ˆæ¬Šè²æ˜ -->
        <div class="copyright">
            <p class="copyright-brand">æ½®æ¬£å°å¹«æ‰‹</p>
            <p>ä¾¿åˆ©å•†åº—ç”Ÿé®®å“æ•ˆæœŸç®¡ç†ç³»çµ±</p>
            <p class="copyright-notice">Â© 2026 ç‹é€¸å› ç‰ˆæ¬Šæ‰€æœ‰</p>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
        let currentPeriod = 'today';

        // è¼‰å…¥æ‰€æœ‰è³‡æ–™
        async function loadAll() {
            await Promise.all([
                loadOverview(),
                loadStaffStats(currentPeriod),
                loadProductStats(),
                loadLogs()
            ]);
        }

        // è¼‰å…¥ç¸½è¦½
        async function loadOverview() {
            try {
                const data = await api('/reports/overview');
                
                // ä»Šæ—¥çµ±è¨ˆ
                document.getElementById('todayStats').innerHTML = `
                    <div class="stat-item">
                        <span class="stat-number">${data.today.sold || 0}</span>
                        <span class="stat-label">âœ¨ å·²å”®å‡º</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${data.today.disposed || 0}</span>
                        <span class="stat-label">ğŸ“¦ å·²ä¸‹æ¶</span>
                    </div>
                    <div class="stat-item ${data.today.sellRate >= 70 ? 'highlight' : 'warning'}">
                        <span class="stat-number">${data.today.sellRate}%</span>
                        <span class="stat-label">å”®å‡ºç‡</span>
                    </div>
                `;

                // æœ¬é€±çµ±è¨ˆ
                document.getElementById('weekStats').innerHTML = `
                    <div class="stat-item">
                        <span class="stat-number">${data.week.sold || 0}</span>
                        <span class="stat-label">âœ¨ å·²å”®å‡º</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${data.week.disposed || 0}</span>
                        <span class="stat-label">ğŸ“¦ å·²ä¸‹æ¶</span>
                    </div>
                    <div class="stat-item ${data.week.sellRate >= 70 ? 'highlight' : 'warning'}">
                        <span class="stat-number">${data.week.sellRate}%</span>
                        <span class="stat-label">å”®å‡ºç‡</span>
                    </div>
                `;
            } catch (error) {
                console.error('è¼‰å…¥ç¸½è¦½å¤±æ•—:', error);
            }
        }

        // è¼‰å…¥åº—å“¡çµ±è¨ˆ
        async function loadStaffStats(period) {
            const container = document.getElementById('staffList');
            try {
                const data = await api(`/reports/staff?period=${period}`);
                
                if (data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">ğŸ“‹</div>
                            <p>é€™æ®µæœŸé–“é‚„æ²’æœ‰æ“ä½œè¨˜éŒ„</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = data.map(staff => {
                    let rateClass = 'good';
                    if (staff.sellRate < 50) rateClass = 'bad';
                    else if (staff.sellRate < 70) rateClass = 'warning';

                    return `
                        <div class="staff-item">
                            <div>
                                <div class="staff-name">${staff.user_name || 'æœªçŸ¥'}</div>
                                <div class="staff-stats">
                                    <span>âœ¨ ${staff.sold_count}</span>
                                    <span>ğŸ“¦ ${staff.disposed_count}</span>
                                </div>
                            </div>
                            <div class="sell-rate ${rateClass}">
                                ${staff.sellRate}%
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('è¼‰å…¥åº—å“¡çµ±è¨ˆå¤±æ•—:', error);
                container.innerHTML = '<div class="empty-state"><p>è¼‰å…¥å¤±æ•—</p></div>';
            }
        }

        // è¼‰å…¥å•†å“çµ±è¨ˆ
        async function loadProductStats() {
            const container = document.getElementById('productList');
            try {
                const data = await api('/reports/products?period=month');
                
                if (data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">ğŸ“¦</div>
                            <p>é‚„æ²’æœ‰å•†å“è™•ç†è¨˜éŒ„</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = data.map(product => `
                    <div class="product-item ${product.needsAttention ? 'attention' : ''}">
                        <div class="product-name">
                            ${product.needsAttention ? 'âš ï¸ ' : ''}${product.product_name}
                        </div>
                        <div class="product-stats">
                            <span style="color: #1DB446;">âœ¨${product.sold}</span>
                            <span style="color: #dc3545;">ğŸ“¦${product.disposed}</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('è¼‰å…¥å•†å“çµ±è¨ˆå¤±æ•—:', error);
                container.innerHTML = '<div class="empty-state"><p>è¼‰å…¥å¤±æ•—</p></div>';
            }
        }

        // è¼‰å…¥æ“ä½œè¨˜éŒ„
        async function loadLogs() {
            const container = document.getElementById('logList');
            try {
                const data = await api('/reports/logs?limit=20');
                
                if (data.logs.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">ğŸ“‹</div>
                            <p>é‚„æ²’æœ‰æ“ä½œè¨˜éŒ„</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = data.logs.map(log => {
                    const time = new Date(log.created_at).toLocaleString('zh-TW');
                    let actionClass = log.action;
                    let actionText = log.action;
                    
                    if (log.action === 'sold') actionText = 'å·²å”®å‡º';
                    else if (log.action === 'disposed') actionText = 'å·²ä¸‹æ¶';
                    else if (log.action === 'register') actionText = 'ç™»è¨˜';

                    return `
                        <div class="log-item">
                            <div class="log-time">${time}</div>
                            <span class="log-action ${actionClass}">${actionText}</span>
                            <strong>${log.user_name || 'åº—å“¡'}</strong>
                            è™•ç†äº†ã€Œ${log.product_name || 'å•†å“'}ã€
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('è¼‰å…¥æ“ä½œè¨˜éŒ„å¤±æ•—:', error);
                container.innerHTML = '<div class="empty-state"><p>è¼‰å…¥å¤±æ•—</p></div>';
            }
        }

        // é€±æœŸåˆ‡æ›
        document.querySelectorAll('.period-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentPeriod = tab.dataset.period;
                loadStaffStats(currentPeriod);
            });
        });

        // åˆå§‹è¼‰å…¥
        loadAll();
    </script>
</body>
</html>
