<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ´ å¹¸é‹æŠ½ç±¤ - æ½®æ¬£å°å¹«æ‰‹</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .fortune-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .draw-button {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(145deg, #FF6B35, #F7941D);
            border: none;
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.4);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 40px auto;
        }
        
        .draw-button:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(255, 107, 53, 0.5);
        }
        
        .draw-button:active {
            transform: scale(0.95);
        }
        
        .draw-button.drawing {
            animation: shake 0.5s ease-in-out infinite;
        }
        
        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }
        
        .draw-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .card-result {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            animation: cardAppear 0.5s ease;
            margin-top: 20px;
        }
        
        @keyframes cardAppear {
            from {
                opacity: 0;
                transform: scale(0.8) rotateY(180deg);
            }
            to {
                opacity: 1;
                transform: scale(1) rotateY(0deg);
            }
        }
        
        .card-result.show {
            display: block;
        }
        
        .rarity-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .rarity-SSR { background: linear-gradient(45deg, #FFD700, #FFA500); }
        .rarity-SR { background: linear-gradient(45deg, #9B59B6, #8E44AD); }
        .rarity-R { background: linear-gradient(45deg, #3498DB, #2980B9); }
        .rarity-Quest { background: linear-gradient(45deg, #E74C3C, #C0392B); }
        
        .card-title {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
        
        .card-subtitle {
            font-size: 18px;
            color: #888;
            margin-bottom: 20px;
        }
        
        .card-scenario {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            color: #666;
            font-size: 14px;
        }
        
        .card-message {
            font-size: 16px;
            line-height: 1.8;
            color: #444;
            padding: 20px 0;
        }
        
        .card-code {
            color: #aaa;
            font-size: 12px;
            text-align: right;
        }
        
        .stats-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .stats-title {
            font-size: 16px;
            font-weight: bold;
            color: #666;
            margin-bottom: 15px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            text-align: center;
        }
        
        .stat-item {
            padding: 10px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 12px;
            color: #888;
        }
        
        .guarantee-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }
        
        .history-section {
            margin-top: 30px;
        }
        
        .history-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .history-rarity {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 15px;
        }
        
        .history-info {
            flex: 1;
        }
        
        .history-title {
            font-weight: bold;
            color: #333;
        }
        
        .history-date {
            font-size: 12px;
            color: #888;
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="/" class="back-btn">â† è¿”å›</a>
        <h1>ğŸ´ å¹¸é‹æŠ½ç±¤</h1>
    </header>

    <main class="main-content">
        <div class="fortune-container">
            <p style="text-align: center; color: #666; margin-bottom: 20px;">
                é»æ“Šä¸‹æ–¹æŒ‰éˆ•æŠ½å–ä»Šæ—¥é‹å‹¢ï½<br>
                <small>ğŸ’¡ å®Œæˆæ•ˆæœŸæª¢æŸ¥å¾Œæ©Ÿç‡åŠ å€ï¼</small>
            </p>
            
            <button class="draw-button" id="drawButton" onclick="drawFortune()">
                <span class="draw-icon">ğŸ´</span>
                <span>æŠ½ä¸€å¼µ</span>
            </button>
            
            <div class="card-result" id="cardResult">
                <div style="text-align: center;">
                    <span class="rarity-badge" id="rarityBadge">SSR</span>
                </div>
                <h2 class="card-title" id="cardTitle">âœ¨ é­”æ³•é¡¯åŒ–</h2>
                <p class="card-subtitle" id="cardSubtitle">å¿ƒæƒ³äº‹æˆ</p>
                <div class="card-scenario" id="cardScenario">
                    ğŸ“ ç•¶ä½ å¿ƒä¸­è¨±ä¸‹ä¸€å€‹é¡˜æœ›æ™‚
                </div>
                <p class="card-message" id="cardMessage">
                    ä½ æ˜¯é€™å®¶åº—çš„é­”æ³•å¸«ã€‚ä½ æƒ³è¦çš„é †åˆ©ã€å®¢äººçš„å¾®ç¬‘ï¼Œåªè¦ä½ ä¸€æƒ³ï¼Œå®‡å®™å°±ç«‹åˆ»ç‚ºä½ å¿«éé€é”ã€‚
                </p>
                <p class="card-code" id="cardCode">ç±¤è™Ÿï¼šA01</p>
                
                <button class="btn btn-primary" onclick="drawFortune()" style="width: 100%; margin-top: 20px;">
                    ğŸ´ å†æŠ½ä¸€å¼µ
                </button>
            </div>
            
            <div class="stats-section" id="statsSection">
                <div class="stats-title">ğŸ“Š æˆ‘çš„æŠ½ç±¤çµ±è¨ˆ</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" style="color: #FFD700;" id="ssrCount">0</div>
                        <div class="stat-label">SSR</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" style="color: #9B59B6;" id="srCount">0</div>
                        <div class="stat-label">SR</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" style="color: #3498DB;" id="rCount">0</div>
                        <div class="stat-label">R</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" style="color: #E74C3C;" id="questCount">0</div>
                        <div class="stat-label">Quest</div>
                    </div>
                </div>
                
                <div class="guarantee-info" id="guaranteeInfo">
                    ğŸŒŸ è·é›¢ä¿åº•é‚„æœ‰ <strong id="untilGuarantee">10</strong> æ¬¡
                </div>
            </div>
            
            <div class="history-section">
                <div class="stats-title">ğŸ“œ æœ€è¿‘æŠ½ç±¤è¨˜éŒ„</div>
                <div id="historyList"></div>
            </div>
        </div>
    </main>

    <script>
        // ä½¿ç”¨å›ºå®š userIdï¼ˆç¶²é ç‰ˆï¼‰
        const WEB_USER_ID = 'web_user_default';
        
        // æŠ½ç±¤
        async function drawFortune() {
            const button = document.getElementById('drawButton');
            const result = document.getElementById('cardResult');
            
            button.classList.add('drawing');
            button.disabled = true;
            result.classList.remove('show');
            
            try {
                const response = await fetch('/api/fortune/draw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userId: WEB_USER_ID,
                        triggerType: 'manual'
                    })
                });
                
                const data = await response.json();
                
                // ç­‰å¾…å‹•ç•«
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // é¡¯ç¤ºçµæœ
                displayCard(data.card);
                loadStats();
                loadHistory();
                
            } catch (error) {
                console.error('æŠ½ç±¤å¤±æ•—:', error);
                alert('æŠ½ç±¤å¤±æ•—ï¼Œè«‹é‡è©¦');
            } finally {
                button.classList.remove('drawing');
                button.disabled = false;
            }
        }
        
        // é¡¯ç¤ºç±¤å¡
        function displayCard(card) {
            const result = document.getElementById('cardResult');
            const rarityBadge = document.getElementById('rarityBadge');
            const cardTitle = document.getElementById('cardTitle');
            const cardSubtitle = document.getElementById('cardSubtitle');
            const cardScenario = document.getElementById('cardScenario');
            const cardMessage = document.getElementById('cardMessage');
            const cardCode = document.getElementById('cardCode');
            
            const rarityText = {
                'SSR': 'ğŸŒŸ SSR - å¤§å‰ ğŸŒŸ',
                'SR': 'âœ¨ SR - ä¸­å‰ âœ¨',
                'R': 'ğŸ’« R - å°å‰ ğŸ’«',
                'Quest': 'âš”ï¸ Quest - æŒ‘æˆ° âš”ï¸'
            };
            
            rarityBadge.textContent = rarityText[card.rarity] || card.rarity;
            rarityBadge.className = 'rarity-badge rarity-' + card.rarity;
            cardTitle.textContent = 'âœ¨ ' + card.title;
            cardSubtitle.textContent = card.subtitle || '';
            cardScenario.textContent = 'ğŸ“ ' + card.scenario;
            cardMessage.textContent = card.message;
            cardCode.textContent = 'ç±¤è™Ÿï¼š' + card.card_code;
            
            result.classList.add('show');
            
            // æ»¾å‹•åˆ°çµæœ
            result.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // è¼‰å…¥çµ±è¨ˆ
        async function loadStats() {
            try {
                const response = await fetch(`/api/fortune/stats/${WEB_USER_ID}`);
                const stats = await response.json();
                
                document.getElementById('ssrCount').textContent = stats.ssr_count || 0;
                document.getElementById('srCount').textContent = stats.sr_count || 0;
                document.getElementById('rCount').textContent = stats.r_count || 0;
                document.getElementById('questCount').textContent = stats.quest_count || 0;
                document.getElementById('untilGuarantee').textContent = stats.until_guarantee || 10;
                
            } catch (error) {
                console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—:', error);
            }
        }
        
        // è¼‰å…¥æ­·å²
        async function loadHistory() {
            try {
                const response = await fetch(`/api/fortune/history/${WEB_USER_ID}?limit=5`);
                const history = await response.json();
                
                const container = document.getElementById('historyList');
                
                if (history.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #888;">é‚„æ²’æœ‰æŠ½ç±¤è¨˜éŒ„</p>';
                    return;
                }
                
                const rarityColors = {
                    'SSR': '#FFD700',
                    'SR': '#9B59B6',
                    'R': '#3498DB',
                    'Quest': '#E74C3C'
                };
                
                const rarityEmoji = {
                    'SSR': 'ğŸŒŸ',
                    'SR': 'âœ¨',
                    'R': 'ğŸ’«',
                    'Quest': 'âš”ï¸'
                };
                
                container.innerHTML = history.map(item => `
                    <div class="history-item">
                        <div class="history-rarity" style="background: ${rarityColors[item.rarity]}20; color: ${rarityColors[item.rarity]};">
                            ${rarityEmoji[item.rarity]}
                        </div>
                        <div class="history-info">
                            <div class="history-title">${item.title}</div>
                            <div class="history-date">${new Date(item.drawn_at).toLocaleString('zh-TW')}</div>
                        </div>
                        <span style="color: ${rarityColors[item.rarity]}; font-weight: bold;">${item.rarity}</span>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('è¼‰å…¥æ­·å²å¤±æ•—:', error);
            }
        }
        
        // é é¢è¼‰å…¥
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadHistory();
        });
    </script>
</body>
</html>
