<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#F7941D">
    <title>系統設定 - 潮欣小幫手</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- 7-11 風格 Header -->
    <header class="header">
        <div class="header-stripes">
            <div class="stripe-orange"></div>
            <div class="stripe-green"></div>
            <div class="stripe-red"></div>
        </div>
        <div class="header-content">
            <span class="header-back" onclick="location.href='/'">←</span>
            <h1>⚙️ 系統設定</h1>
            <p class="subtitle">通知時間設定</p>
        </div>
    </header>

    <div class="container">
        <!-- 通知設定 -->
        <div class="settings-section">
            <h3>🔔 通知設定</h3>
            
            <div class="form-group">
                <label>提前通知時間</label>
                <select id="notificationHours">
                    <option value="6">6 小時前</option>
                    <option value="12">12 小時前</option>
                    <option value="24" selected>24 小時前（建議）</option>
                    <option value="48">48 小時前</option>
                    <option value="72">72 小時前</option>
                </select>
                <p class="helper-text">系統會在商品到期前多久發送提醒</p>
            </div>
            
            <div class="form-group">
                <label>啟用自動通知</label>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <input type="checkbox" id="notificationEnabled" checked style="width: 24px; height: 24px; accent-color: var(--seven-orange);">
                    <span class="text-muted">啟用後，系統會自動發送效期提醒到 LINE 群組</span>
                </div>
            </div>
        </div>

        <!-- 定時發送設定 -->
        <div class="settings-section">
            <h3>⏰ 定時發送設定</h3>
            
            <div class="form-group">
                <label>每日發送時間</label>
                <input type="time" id="notificationTime" value="09:00">
                <p class="helper-text">系統每天會在這個時間自動檢查並發送效期提醒</p>
            </div>
            
            <div style="background: var(--seven-orange-light); padding: 14px; border-radius: var(--radius-sm); margin-top: 16px;">
                <p style="font-size: 0.8rem; color: var(--seven-orange);">
                    ⚠️ 注意：定時發送功能需要伺服器持續運行
                </p>
            </div>
        </div>

        <!-- 儲存按鈕 -->
        <button class="btn btn-primary" id="saveBtn">
            💾 儲存設定
        </button>

        <!-- 手動發送提醒 -->
        <div class="settings-section" style="margin-top: 24px;">
            <h3>🧪 手動測試</h3>
            <p class="text-muted" style="font-size: 0.875rem; margin-bottom: 16px;">
                點擊下方按鈕可以立即發送一次效期提醒到 LINE 群組
            </p>
            <button class="btn btn-outline" id="testNotifyBtn">
                📤 立即發送提醒
            </button>
        </div>

        <!-- 版權聲明 -->
        <div class="copyright">
            <p class="copyright-brand">潮欣小幫手</p>
            <p>便利商店生鮮品效期管理系統</p>
            <p class="copyright-notice">© 2026 王逸君 版權所有<br>未經授權禁止複製、修改或商業使用</p>
            <p class="copyright-contact">授權洽詢：Hour Light International Co., Ltd.</p>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
        async function init() {
            try {
                const settings = await loadSettings();
                
                if (settings.notification_hours_before) {
                    document.getElementById('notificationHours').value = settings.notification_hours_before;
                }
                
                if (settings.notification_enabled !== undefined) {
                    document.getElementById('notificationEnabled').checked = settings.notification_enabled === 'true';
                }

                if (settings.notification_cron_time) {
                    const parts = settings.notification_cron_time.split(' ');
                    if (parts.length >= 3) {
                        const hour = parts[2].padStart(2, '0');
                        const minute = parts[1].padStart(2, '0');
                        document.getElementById('notificationTime').value = `${hour}:${minute}`;
                    }
                }
            } catch (error) {
                console.error('載入設定失敗:', error);
            }
        }

        document.getElementById('saveBtn').addEventListener('click', async () => {
            const timeValue = document.getElementById('notificationTime').value;
            const [hour, minute] = timeValue.split(':');
            const cronTime = `0 ${parseInt(minute)} ${parseInt(hour)} * * *`;

            const settings = {
                notification_hours_before: document.getElementById('notificationHours').value,
                notification_enabled: document.getElementById('notificationEnabled').checked ? 'true' : 'false',
                notification_cron_time: cronTime
            };

            await saveSettings(settings);
        });

        document.getElementById('testNotifyBtn').addEventListener('click', async () => {
            const btn = document.getElementById('testNotifyBtn');
            btn.disabled = true;
            btn.textContent = '發送中...';

            try {
                const result = await api('/notify/manual', { method: 'POST' });
                
                if (result.count === 0) {
                    showToast('目前沒有即將到期的商品', 'success');
                } else {
                    showToast(`✅ 已發送提醒，共 ${result.count} 個商品`, 'success');
                }
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = '📤 立即發送提醒';
            }
        });

        init();
    </script>
</body>
</html>
