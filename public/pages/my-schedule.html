<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“… æˆ‘çš„ç­è¡¨ - æ½®æ¬£å°å¹«æ‰‹</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .my-schedule-container { max-width: 500px; margin: 0 auto; padding: 15px; }
        
        .user-card {
            background: linear-gradient(135deg, var(--primary-orange), #FF8C00);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        .user-card h2 { margin: 0 0 5px 0; }
        .user-card p { margin: 0; opacity: 0.9; }
        
        .schedule-list { display: flex; flex-direction: column; gap: 10px; }
        
        .schedule-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .schedule-item.today { border-left: 4px solid var(--primary-orange); }
        .schedule-item.tomorrow { border-left: 4px solid var(--secondary-green); }
        
        .date-badge {
            min-width: 60px;
            text-align: center;
        }
        .date-badge .day-num { font-size: 24px; font-weight: bold; color: #333; }
        .date-badge .day-name { font-size: 12px; color: #666; }
        .date-badge.today .day-num { color: var(--primary-orange); }
        
        .shift-info { flex: 1; }
        .shift-info h4 { margin: 0 0 5px 0; font-size: 16px; }
        .shift-info p { margin: 0; font-size: 13px; color: #666; }
        
        .shift-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
        }
        .shift-morning { background: #FFF3E0; color: #E65100; }
        .shift-evening { background: #E3F2FD; color: #1565C0; }
        .shift-night { background: #EDE7F6; color: #4527A0; }
        .shift-off { background: #E8F5E9; color: #2E7D32; }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        .empty-state p { font-size: 40px; margin: 0 0 15px 0; }
        
        .bind-form {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
        }
        .bind-form input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
            box-sizing: border-box;
        }
        .bind-form button {
            width: 100%;
            padding: 12px;
            background: var(--primary-orange);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .who-works {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
        }
        .who-works h4 { margin: 0 0 10px 0; font-size: 14px; color: #666; }
        .who-works-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .coworker { background: white; padding: 5px 12px; border-radius: 20px; font-size: 13px; }
    </style>
</head>
<body>
    <div class="my-schedule-container">
        <!-- æœªç¶å®šç‹€æ…‹ -->
        <div id="bindView" style="display: none;">
            <div style="text-align: center; margin: 50px 0 30px 0;">
                <p style="font-size: 60px; margin: 0;">ğŸ‘¤</p>
                <h2>æŸ¥è©¢æˆ‘çš„ç­è¡¨</h2>
                <p style="color: #666;">è«‹å…ˆè¼¸å…¥æ‚¨çš„å§“åé€²è¡Œç¶å®š</p>
            </div>
            
            <div class="bind-form">
                <p>è«‹è¼¸å…¥æ‚¨åœ¨ç­è¡¨ä¸Šçš„å§“åï¼š</p>
                <input type="text" id="employeeName" placeholder="ä¾‹å¦‚ï¼šå°æ˜">
                <button onclick="bindEmployee()">ğŸ” æŸ¥è©¢ç­è¡¨</button>
            </div>
        </div>

        <!-- å·²ç¶å®šç‹€æ…‹ -->
        <div id="scheduleView" style="display: none;">
            <div class="user-card">
                <h2 id="userName">è¼‰å…¥ä¸­...</h2>
                <p id="userRole">å“¡å·¥</p>
            </div>

            <h3 style="margin: 20px 0 15px 0;">ğŸ“… æœªä¾† 7 å¤©ç­è¡¨</h3>
            
            <div class="schedule-list" id="scheduleList">
                <!-- ç­è¡¨æœƒå‹•æ…‹å¡«å…¥ -->
            </div>

            <div class="who-works" id="todayCoworkers" style="display: none;">
                <h4>ğŸ¤ ä»Šå¤©ä¸€èµ·ä¸Šç­çš„å¤¥ä¼´</h4>
                <div class="who-works-list" id="coworkerList"></div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button onclick="switchEmployee()" style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 8px; cursor: pointer;">ğŸ”„ åˆ‡æ›å“¡å·¥</button>
            </div>
        </div>

        <!-- è¿”å›é¦–é  -->
        <div style="text-align: center; margin-top: 30px;">
            <a href="/" style="display: inline-block; padding: 12px 30px; background: var(--secondary-green); color: white; text-decoration: none; border-radius: 8px;">ğŸ  è¿”å›é¦–é </a>
        </div>
    </div>

    <script>
        const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        let currentEmployee = null;

        // æª¢æŸ¥æœ¬åœ°å„²å­˜çš„å“¡å·¥è³‡è¨Š
        function checkStoredEmployee() {
            const stored = localStorage.getItem('myEmployeeId');
            if (stored) {
                loadMySchedule(stored);
            } else {
                document.getElementById('bindView').style.display = 'block';
                document.getElementById('scheduleView').style.display = 'none';
            }
        }

        // ç¶å®šå“¡å·¥
        async function bindEmployee() {
            const name = document.getElementById('employeeName').value.trim();
            if (!name) {
                alert('è«‹è¼¸å…¥å§“å');
                return;
            }

            try {
                // å…ˆæŸ¥è©¢å“¡å·¥åˆ—è¡¨
                const res = await fetch('/api/schedule/employees');
                const employees = await res.json();
                
                // æ‰¾åˆ°ç¬¦åˆçš„å“¡å·¥
                const employee = employees.find(e => e.name === name);
                
                if (!employee) {
                    alert('æ‰¾ä¸åˆ°æ­¤å“¡å·¥ï¼Œè«‹ç¢ºèªå§“åæ˜¯å¦æ­£ç¢º');
                    return;
                }

                // å„²å­˜åˆ°æœ¬åœ°
                localStorage.setItem('myEmployeeId', employee.id);
                localStorage.setItem('myEmployeeName', employee.name);
                
                loadMySchedule(employee.id);
            } catch (error) {
                alert('æŸ¥è©¢å¤±æ•—ï¼š' + error.message);
            }
        }

        // è¼‰å…¥æˆ‘çš„ç­è¡¨
        async function loadMySchedule(employeeId) {
            try {
                // å–å¾—å“¡å·¥è³‡è¨Š
                const empRes = await fetch('/api/schedule/employees');
                const employees = await empRes.json();
                currentEmployee = employees.find(e => e.id == employeeId);

                if (!currentEmployee) {
                    localStorage.removeItem('myEmployeeId');
                    checkStoredEmployee();
                    return;
                }

                // é¡¯ç¤ºå“¡å·¥è³‡è¨Š
                document.getElementById('userName').textContent = currentEmployee.name;
                document.getElementById('userRole').textContent = 
                    currentEmployee.role === 'manager' ? 'ğŸ‘‘ åº—é•·' : 'ğŸ’¼ å“¡å·¥';

                // å–å¾—æœªä¾† 7 å¤©ç­è¡¨
                const today = new Date();
                const startDate = today.toISOString().split('T')[0];
                const endDate = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

                const scheduleRes = await fetch(`/api/schedule/schedules?employee_id=${employeeId}&start_date=${startDate}&end_date=${endDate}`);
                const schedules = await scheduleRes.json();

                renderSchedules(schedules);
                loadTodayCoworkers();

                document.getElementById('bindView').style.display = 'none';
                document.getElementById('scheduleView').style.display = 'block';
            } catch (error) {
                console.error('è¼‰å…¥ç­è¡¨å¤±æ•—:', error);
                alert('è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }

        // æ¸²æŸ“ç­è¡¨
        function renderSchedules(schedules) {
            const list = document.getElementById('scheduleList');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // å»ºç«‹ 7 å¤©çš„æ—¥æœŸé™£åˆ—
            const days = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(today.getTime() + i * 24 * 60 * 60 * 1000);
                days.push(d.toISOString().split('T')[0]);
            }

            // å»ºç«‹ç­è¡¨æ˜ å°„
            const scheduleMap = {};
            schedules.forEach(s => {
                const dateStr = new Date(s.work_date).toISOString().split('T')[0];
                scheduleMap[dateStr] = s;
            });

            list.innerHTML = days.map((dateStr, idx) => {
                const date = new Date(dateStr);
                const schedule = scheduleMap[dateStr];
                const isToday = idx === 0;
                const isTomorrow = idx === 1;

                let shiftName = 'æœªæ’ç­';
                let shiftClass = '';
                let timeText = '';

                if (schedule) {
                    if (schedule.shift_type === 'off') {
                        shiftName = 'ğŸ–ï¸ ä¼‘å‡';
                        shiftClass = 'shift-off';
                    } else if (schedule.shift_name) {
                        shiftName = schedule.shift_name;
                        shiftClass = `shift-${schedule.shift_type}`;
                        timeText = `${schedule.start_time?.substring(0,5)} - ${schedule.end_time?.substring(0,5)}`;
                    }
                }

                return `
                    <div class="schedule-item ${isToday ? 'today' : ''} ${isTomorrow ? 'tomorrow' : ''}">
                        <div class="date-badge ${isToday ? 'today' : ''}">
                            <div class="day-num">${date.getDate()}</div>
                            <div class="day-name">${isToday ? 'ä»Šå¤©' : isTomorrow ? 'æ˜å¤©' : 'é€±' + weekDays[date.getDay()]}</div>
                        </div>
                        <div class="shift-info">
                            <h4>${shiftName}</h4>
                            <p>${timeText || (schedule?.shift_type === 'off' ? 'å¥½å¥½ä¼‘æ¯ï½' : 'ç­‰å¾…æ’ç­')}</p>
                        </div>
                        ${schedule && schedule.shift_type !== 'off' ? `<span class="shift-badge ${shiftClass}">${schedule.shift_type === 'morning' ? 'æ—©' : schedule.shift_type === 'evening' ? 'æ™š' : 'å¤œ'}</span>` : ''}
                    </div>
                `;
            }).join('');
        }

        // è¼‰å…¥ä»Šå¤©ä¸€èµ·ä¸Šç­çš„äºº
        async function loadTodayCoworkers() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const res = await fetch(`/api/schedule/who-works?date=${today}`);
                const data = await res.json();

                // æ‰¾å‡ºåŒç­åˆ¥çš„åŒäº‹
                const mySchedule = await fetch(`/api/schedule/schedules?employee_id=${currentEmployee.id}&start_date=${today}&end_date=${today}`);
                const myData = await mySchedule.json();
                
                if (myData.length === 0 || myData[0].shift_type === 'off') {
                    document.getElementById('todayCoworkers').style.display = 'none';
                    return;
                }

                const myShift = myData[0].shift_type;
                const coworkers = data.shifts[myShift]?.filter(c => c.employee_id !== currentEmployee.id) || [];

                if (coworkers.length > 0) {
                    document.getElementById('coworkerList').innerHTML = coworkers.map(c => 
                        `<span class="coworker">${c.employee_name}</span>`
                    ).join('');
                    document.getElementById('todayCoworkers').style.display = 'block';
                } else {
                    document.getElementById('todayCoworkers').style.display = 'none';
                }
            } catch (error) {
                console.error('è¼‰å…¥åŒäº‹è³‡è¨Šå¤±æ•—:', error);
            }
        }

        // åˆ‡æ›å“¡å·¥
        function switchEmployee() {
            localStorage.removeItem('myEmployeeId');
            localStorage.removeItem('myEmployeeName');
            document.getElementById('employeeName').value = '';
            checkStoredEmployee();
        }

        // åˆå§‹åŒ–
        checkStoredEmployee();
    </script>
</body>
</html>
