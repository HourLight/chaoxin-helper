<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“… ç­è¡¨ç®¡ç† - æ½®æ¬£å°å¹«æ‰‹</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .schedule-container { max-width: 100%; margin: 0 auto; padding: 10px; }
        
        /* é ç±¤ */
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 20px; border: none; background: #f0f0f0; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .tab-btn.active { background: var(--primary-orange); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* é€±é¸æ“‡å™¨ */
        .week-selector { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .week-nav { display: flex; gap: 5px; }
        .week-nav button { padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-size: 13px; }
        .week-nav button:hover { background: #f5f5f5; }
        .week-display { font-size: 15px; font-weight: bold; color: var(--primary-orange); }
        
        /* ç­è¡¨è¡¨æ ¼ */
        .schedule-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .schedule-table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 700px; }
        .schedule-table th, .schedule-table td { border: 1px solid #ddd; text-align: center; vertical-align: middle; }
        .schedule-table th { background: var(--secondary-green); color: white; padding: 10px 5px; font-size: 11px; }
        .schedule-table th.employee-header { width: 70px; min-width: 70px; }
        .schedule-table th.day-header { width: calc((100% - 70px) / 7); }
        
        .schedule-table td.employee-name { 
            background: #f9f9f9; font-weight: bold; padding: 8px 5px; font-size: 13px;
            position: sticky; left: 0; z-index: 1;
        }
        
        /* ç­åˆ¥æ ¼å­ */
        .shift-cell { padding: 5px; cursor: pointer; min-height: 50px; transition: all 0.2s; position: relative; }
        .shift-cell:hover { background: #fff9f5; }
        .shift-cell.has-note::after { content: 'ğŸ“'; position: absolute; top: 2px; right: 2px; font-size: 10px; }
        
        /* ç­åˆ¥æŒ‰éˆ• */
        .shift-btn { display: block; width: 100%; padding: 8px 4px; border: none; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer; }
        .shift-btn.morning { background: #FFF3E0; color: #E65100; border: 2px solid #FFB74D; }
        .shift-btn.evening { background: #E3F2FD; color: #1565C0; border: 2px solid #64B5F6; }
        .shift-btn.night { background: #EDE7F6; color: #4527A0; border: 2px solid #9575CD; }
        .shift-btn.off { background: #E8F5E9; color: #2E7D32; border: 2px solid #81C784; }
        .shift-btn.empty { background: #fafafa; color: #999; border: 2px dashed #ddd; }
        
        /* ç­åˆ¥é¸æ“‡å½ˆçª— */
        .shift-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .shift-modal.show { display: flex; }
        .shift-modal-content { background: white; border-radius: 15px; padding: 20px; width: 90%; max-width: 320px; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .shift-modal h3 { margin: 0 0 15px 0; text-align: center; }
        .shift-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .shift-option { padding: 15px 10px; border: 2px solid #eee; border-radius: 10px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .shift-option:hover { border-color: var(--primary-orange); }
        .shift-option.selected { border-color: var(--primary-orange); background: #fff9f5; }
        .shift-option .icon { font-size: 24px; display: block; margin-bottom: 5px; }
        .shift-option .name { font-weight: bold; font-size: 14px; }
        .shift-option .time { font-size: 11px; color: #666; }
        
        .note-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; font-size: 14px; }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-buttons button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; }
        .btn-cancel { background: #f0f0f0; color: #666; }
        .btn-save { background: var(--primary-orange); color: white; }
        .btn-clear { background: #f44336; color: white; }
        
        /* å„²å­˜åˆ— */
        .save-bar { position: sticky; bottom: 0; background: white; padding: 12px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; }
        .save-btn { padding: 12px 30px; background: var(--primary-orange); color: white; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; }
        .save-btn:disabled { background: #ccc; }
        .change-count { color: #666; font-size: 13px; }
        
        /* å“¡å·¥ç®¡ç† */
        .employee-list { display: grid; gap: 10px; }
        .employee-card { background: white; border: 1px solid #eee; border-radius: 10px; padding: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .employee-info h4 { margin: 0 0 5px 0; }
        .employee-info p { margin: 0; font-size: 13px; color: #666; }
        .employee-actions { display: flex; gap: 8px; }
        .employee-actions button { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .btn-edit { background: #2196F3; color: white; }
        .btn-delete { background: #f44336; color: white; }
        
        .add-form { background: #f9f9f9; border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .form-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .form-row input, .form-row select { flex: 1; min-width: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        
        .legend { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; font-size: 12px; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-color { width: 20px; height: 20px; border-radius: 4px; }
        
        @media (max-width: 768px) {
            .schedule-table { font-size: 11px; }
            .shift-btn { padding: 6px 2px; font-size: 10px; }
        }
    </style>
</head>
<body>
    <div class="schedule-container">
        <header style="margin-bottom: 15px;">
            <h1 style="margin: 0; font-size: 22px;">ğŸ“… ç­è¡¨ç®¡ç†</h1>
            <p style="color: #666; margin: 5px 0 0 0; font-size: 13px;">é»é¸æ ¼å­å³å¯æ’ç­ï¼Œå¯åŠ å‚™è¨»</p>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('schedule')">ğŸ“… æ’ç­è¡¨</button>
            <button class="tab-btn" onclick="switchTab('employees')">ğŸ‘¥ å“¡å·¥ç®¡ç†</button>
        </div>

        <!-- æ’ç­è¡¨ -->
        <div id="tab-schedule" class="tab-content active">
            <div class="week-selector">
                <div class="week-nav">
                    <button onclick="changeWeek(-1)">â—€</button>
                    <button onclick="changeWeek(0)">æœ¬é€±</button>
                    <button onclick="changeWeek(1)">â–¶</button>
                </div>
                <div class="week-display" id="weekDisplay">è¼‰å…¥ä¸­...</div>
            </div>

            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background: #FFF3E0; border: 1px solid #FFB74D;"></div> æ—©ç­</div>
                <div class="legend-item"><div class="legend-color" style="background: #E3F2FD; border: 1px solid #64B5F6;"></div> æ™šç­</div>
                <div class="legend-item"><div class="legend-color" style="background: #EDE7F6; border: 1px solid #9575CD;"></div> å¤§å¤œ</div>
                <div class="legend-item"><div class="legend-color" style="background: #E8F5E9; border: 1px solid #81C784;"></div> ä¼‘å‡</div>
                <div class="legend-item">ğŸ“ æœ‰å‚™è¨»</div>
            </div>

            <div class="schedule-wrapper">
                <table class="schedule-table" id="scheduleTable">
                    <thead><tr id="tableHeader"><th class="employee-header">å“¡å·¥</th></tr></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>

            <div class="save-bar">
                <span class="change-count" id="changeCount">å°šç„¡è®Šæ›´</span>
                <button class="save-btn" id="saveBtn" onclick="saveSchedules()" disabled>ğŸ’¾ å„²å­˜ç­è¡¨</button>
            </div>
        </div>

        <!-- å“¡å·¥ç®¡ç† -->
        <div id="tab-employees" class="tab-content">
            <div class="add-form">
                <h3 style="margin: 0 0 10px 0; font-size: 15px;">â• æ–°å¢å“¡å·¥</h3>
                <div class="form-row">
                    <input type="text" id="newEmployeeName" placeholder="å§“å">
                    <input type="text" id="newEmployeePhone" placeholder="é›»è©±ï¼ˆé¸å¡«ï¼‰">
                    <select id="newEmployeeRole"><option value="staff">å“¡å·¥</option><option value="manager">åº—é•·</option></select>
                    <button onclick="addEmployee()" style="background: var(--secondary-green); color: white; border: none; border-radius: 6px; padding: 10px 15px;">æ–°å¢</button>
                </div>
            </div>
            <h3 style="font-size: 15px;">ğŸ‘¥ å“¡å·¥åˆ—è¡¨ï¼ˆ<span id="employeeCount">0</span> äººï¼‰</h3>
            <div class="employee-list" id="employeeList"></div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <a href="/" style="display: inline-block; padding: 10px 25px; background: #666; color: white; text-decoration: none; border-radius: 8px;">ğŸ  è¿”å›é¦–é </a>
        </div>
    </div>

    <!-- ç­åˆ¥é¸æ“‡å½ˆçª— -->
    <div class="shift-modal" id="shiftModal">
        <div class="shift-modal-content">
            <h3 id="modalTitle">é¸æ“‡ç­åˆ¥</h3>
            <div class="shift-options">
                <div class="shift-option" data-shift="morning" onclick="selectShiftOption('morning')">
                    <span class="icon">â˜€ï¸</span><span class="name">æ—©ç­</span><span class="time">07:00-15:00</span>
                </div>
                <div class="shift-option" data-shift="evening" onclick="selectShiftOption('evening')">
                    <span class="icon">ğŸŒ…</span><span class="name">æ™šç­</span><span class="time">15:00-23:00</span>
                </div>
                <div class="shift-option" data-shift="night" onclick="selectShiftOption('night')">
                    <span class="icon">ğŸŒ™</span><span class="name">å¤§å¤œç­</span><span class="time">23:00-07:00</span>
                </div>
                <div class="shift-option" data-shift="off" onclick="selectShiftOption('off')">
                    <span class="icon">ğŸ–ï¸</span><span class="name">ä¼‘å‡</span><span class="time">å¥½å¥½ä¼‘æ¯</span>
                </div>
            </div>
            <input type="text" class="note-input" id="noteInput" placeholder="ğŸ“ å‚™è¨»ï¼ˆä»£ç­ã€è«‹å‡åŸå› ...ï¼‰" maxlength="50">
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn-clear" onclick="clearShift()">æ¸…é™¤</button>
                <button class="btn-save" onclick="confirmShift()">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <script>
        let currentWeekOffset = 0, employees = [], weekDays = [], scheduleData = {}, pendingChanges = {};
        let currentCell = { employeeId: null, date: null }, selectedShift = null;

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            if (tabName === 'employees') loadEmployees();
        }

        async function loadEmployees() {
            try {
                const res = await fetch('/api/schedule/employees');
                employees = await res.json();
                renderEmployeeList();
            } catch (error) { console.error('è¼‰å…¥å“¡å·¥å¤±æ•—:', error); }
        }

        function renderEmployeeList() {
            document.getElementById('employeeCount').textContent = employees.length;
            document.getElementById('employeeList').innerHTML = employees.map(emp => `
                <div class="employee-card">
                    <div class="employee-info">
                        <h4>${emp.role === 'manager' ? 'ğŸ‘‘ ' : ''}${emp.name}</h4>
                        <p>ğŸ“ ${emp.phone || 'æœªå¡«'}</p>
                    </div>
                    <div class="employee-actions">
                        <button class="btn-edit" onclick="editEmployee(${emp.id}, '${emp.name}', '${emp.phone || ''}', '${emp.role}')">âœï¸</button>
                        <button class="btn-delete" onclick="deleteEmployee(${emp.id}, '${emp.name}')">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        }

        async function addEmployee() {
            const name = document.getElementById('newEmployeeName').value.trim();
            const phone = document.getElementById('newEmployeePhone').value.trim();
            const role = document.getElementById('newEmployeeRole').value;
            if (!name) { alert('è«‹è¼¸å…¥å§“å'); return; }
            const res = await fetch('/api/schedule/employees', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, phone, role })
            });
            const data = await res.json();
            if (data.success) {
                alert('âœ… æ–°å¢æˆåŠŸï¼');
                document.getElementById('newEmployeeName').value = '';
                document.getElementById('newEmployeePhone').value = '';
                loadEmployees(); loadWeekSchedule();
            }
        }

        function editEmployee(id, name, phone, role) {
            const newName = prompt('å§“åï¼š', name);
            if (newName === null) return;
            const newPhone = prompt('é›»è©±ï¼š', phone);
            const newRole = confirm('æ˜¯å¦ç‚ºåº—é•·ï¼Ÿ') ? 'manager' : 'staff';
            fetch(`/api/schedule/employees/${id}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newName, phone: newPhone, role: newRole })
            }).then(() => { loadEmployees(); loadWeekSchedule(); });
        }

        async function deleteEmployee(id, name) {
            if (!confirm(`ç¢ºå®šåˆªé™¤ã€Œ${name}ã€ï¼Ÿ`)) return;
            await fetch(`/api/schedule/employees/${id}`, { method: 'DELETE' });
            loadEmployees(); loadWeekSchedule();
        }

        async function loadWeekSchedule() {
            try {
                const targetDate = new Date();
                targetDate.setDate(targetDate.getDate() + (currentWeekOffset * 7));
                const res = await fetch(`/api/schedule/schedules/week?date=${targetDate.toISOString().split('T')[0]}`);
                const data = await res.json();
                
                weekDays = data.days;
                scheduleData = {};
                data.data.forEach(row => {
                    row.schedules.forEach(s => {
                        const dateKey = typeof s.work_date === 'string' ? s.work_date : 
                            (s.work_date ? new Date(s.work_date).toISOString().split('T')[0] : null);
                        if (dateKey) scheduleData[`${row.employee.id}-${dateKey}`] = { shift_type: s.shift_type, notes: s.notes };
                    });
                });
                renderWeekSchedule(data);
                pendingChanges = {};
                updateSaveButton();
            } catch (error) { console.error('è¼‰å…¥ç­è¡¨å¤±æ•—:', error); }
        }

        function renderWeekSchedule(data) {
            const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('weekDisplay').textContent = `${data.week_start} ~ ${data.week_end}`;

            document.getElementById('tableHeader').innerHTML = '<th class="employee-header">å“¡å·¥</th>' + 
                data.days.map(d => {
                    const date = new Date(d), isToday = d === today;
                    return `<th class="day-header" style="${isToday ? 'background: var(--primary-orange);' : ''}">${date.getDate()}(${dayNames[date.getDay()]})</th>`;
                }).join('');

            document.getElementById('tableBody').innerHTML = data.data.map(row => {
                const emp = row.employee;
                const cells = data.days.map(d => {
                    const key = `${emp.id}-${d}`, schedule = scheduleData[key] || {};
                    return `<td class="shift-cell ${schedule.notes ? 'has-note' : ''}" onclick="openShiftModal(${emp.id}, '${d}', '${emp.name}')" data-emp="${emp.id}" data-date="${d}">${renderShiftButton(schedule.shift_type || '', schedule.notes || '')}</td>`;
                }).join('');
                return `<tr><td class="employee-name">${emp.role === 'manager' ? 'ğŸ‘‘' : ''} ${emp.name}</td>${cells}</tr>`;
            }).join('');
        }

        function renderShiftButton(shift, note) {
            if (!shift) return `<button class="shift-btn empty">é»é¸</button>`;
            const labels = { morning: 'â˜€ï¸æ—©', evening: 'ğŸŒ…æ™š', night: 'ğŸŒ™å¤œ', off: 'ğŸ–ï¸ä¼‘' };
            return `<button class="shift-btn ${shift}">${labels[shift] || shift}</button>`;
        }

        function openShiftModal(empId, date, empName) {
            currentCell = { employeeId: empId, date: date };
            const key = `${empId}-${date}`, existing = pendingChanges[key] || scheduleData[key] || {};
            selectedShift = existing.shift_type || null;
            document.getElementById('noteInput').value = existing.notes || '';
            const dateObj = new Date(date), dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            document.getElementById('modalTitle').textContent = `${empName} - ${dateObj.getMonth()+1}/${dateObj.getDate()}(${dayNames[dateObj.getDay()]})`;
            document.querySelectorAll('.shift-option').forEach(opt => opt.classList.toggle('selected', opt.dataset.shift === selectedShift));
            document.getElementById('shiftModal').classList.add('show');
        }

        function selectShiftOption(shift) {
            selectedShift = shift;
            document.querySelectorAll('.shift-option').forEach(opt => opt.classList.toggle('selected', opt.dataset.shift === shift));
        }

        function confirmShift() {
            if (!selectedShift) { alert('è«‹é¸æ“‡ç­åˆ¥'); return; }
            const note = document.getElementById('noteInput').value.trim();
            const key = `${currentCell.employeeId}-${currentCell.date}`;
            pendingChanges[key] = { employee_id: currentCell.employeeId, work_date: currentCell.date, shift_type: selectedShift, notes: note };
            const cell = document.querySelector(`td[data-emp="${currentCell.employeeId}"][data-date="${currentCell.date}"]`);
            if (cell) { cell.innerHTML = renderShiftButton(selectedShift, note); cell.classList.toggle('has-note', !!note); }
            updateSaveButton(); closeModal();
        }

        function clearShift() {
            const key = `${currentCell.employeeId}-${currentCell.date}`;
            pendingChanges[key] = { employee_id: currentCell.employeeId, work_date: currentCell.date, shift_type: '', notes: '' };
            const cell = document.querySelector(`td[data-emp="${currentCell.employeeId}"][data-date="${currentCell.date}"]`);
            if (cell) { cell.innerHTML = renderShiftButton('', ''); cell.classList.remove('has-note'); }
            updateSaveButton(); closeModal();
        }

        function closeModal() { document.getElementById('shiftModal').classList.remove('show'); selectedShift = null; }

        function updateSaveButton() {
            const count = Object.keys(pendingChanges).length;
            document.getElementById('saveBtn').disabled = count === 0;
            document.getElementById('changeCount').textContent = count > 0 ? `æœ‰ ${count} ç­†è®Šæ›´` : 'å°šç„¡è®Šæ›´';
        }

        async function saveSchedules() {
            const schedules = Object.values(pendingChanges).filter(s => s.shift_type);
            if (schedules.length === 0) { alert('æ²’æœ‰éœ€è¦å„²å­˜çš„è®Šæ›´'); return; }
            document.getElementById('saveBtn').textContent = 'å„²å­˜ä¸­...';
            document.getElementById('saveBtn').disabled = true;
            await fetch('/api/schedule/schedules/batch', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ schedules, created_by: 'web_manager' })
            });
            alert('âœ… ç­è¡¨å·²å„²å­˜ï¼');
            pendingChanges = {};
            loadWeekSchedule();
            document.getElementById('saveBtn').textContent = 'ğŸ’¾ å„²å­˜ç­è¡¨';
        }

        function changeWeek(offset) {
            if (Object.keys(pendingChanges).length > 0 && !confirm('æœ‰æœªå„²å­˜çš„è®Šæ›´ï¼Œç¢ºå®šåˆ‡æ›ï¼Ÿ')) return;
            currentWeekOffset = offset === 0 ? 0 : currentWeekOffset + offset;
            loadWeekSchedule();
        }

        document.getElementById('shiftModal').addEventListener('click', function(e) { if (e.target === this) closeModal(); });

        async function init() { await loadEmployees(); await loadWeekSchedule(); }
        init();
    </script>
</body>
</html>
