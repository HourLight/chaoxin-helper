<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#F7941D">
    <title>å¿«é€Ÿå•†å“ç™»è¨˜ - æ½®æ¬£å°å¹«æ‰‹</title>
    <link rel="stylesheet" href="/css/style.css">
    <!-- æ¢ç¢¼æƒæå‡½å¼åº« -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        .barcode-input-wrapper {
            position: relative;
        }
        
        .barcode-input-wrapper input {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: 2px;
            text-align: center;
            padding: 20px;
        }
        
        .scan-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
            opacity: 0.7;
            transition: all 0.2s;
        }
        
        .scan-icon:hover {
            opacity: 1;
            transform: translateY(-50%) scale(1.1);
        }
        
        .scanner-container {
            background: #000;
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-bottom: 16px;
        }
        
        .scanner-container.hidden {
            display: none;
        }
        
        #scanner {
            width: 100%;
            min-height: 250px;
        }
        
        #scanner video {
            width: 100% !important;
            border-radius: var(--radius-md);
        }
        
        .product-found {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border: 2px solid var(--seven-green);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .product-found-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }
        
        .product-found-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--seven-green-dark);
            margin-bottom: 4px;
        }
        
        .product-found-info {
            font-size: 0.85rem;
            color: var(--seven-green);
        }
        
        .product-new {
            background: linear-gradient(135deg, var(--seven-orange-light) 0%, #FFE0B2 100%);
            border: 2px solid var(--seven-orange);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .product-new-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }
        
        .product-new-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--seven-orange-dark);
            margin-bottom: 4px;
        }
        
        .product-new-info {
            font-size: 0.85rem;
            color: var(--seven-orange);
        }
        
        .quick-category-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .category-btn {
            padding: 12px 8px;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-sm);
            background: var(--white);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .category-btn:hover {
            border-color: var(--seven-orange);
            background: var(--seven-orange-light);
        }
        
        .category-btn.selected {
            border-color: var(--seven-orange);
            background: var(--seven-orange);
            color: white;
        }
        
        .category-btn .emoji {
            font-size: 1.25rem;
            display: block;
            margin-bottom: 4px;
        }
        
        .expiry-shortcuts {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .expiry-shortcut {
            padding: 8px 14px;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-sm);
            background: var(--white);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .expiry-shortcut:hover {
            border-color: var(--seven-green);
            background: var(--seven-green-light);
        }
        
        .quantity-big {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 16px;
            background: var(--gray-100);
            border-radius: var(--radius-md);
        }
        
        .quantity-big .qty-btn {
            width: 56px;
            height: 56px;
            font-size: 1.75rem;
            border-radius: 50%;
            border: 2px solid var(--gray-300);
            background: var(--white);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quantity-big .qty-btn:hover {
            border-color: var(--seven-orange);
            background: var(--seven-orange-light);
        }
        
        .quantity-big .qty-display {
            font-size: 2rem;
            font-weight: 700;
            min-width: 60px;
            text-align: center;
        }
        
        .success-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 40px 24px;
            text-align: center;
            box-shadow: var(--shadow-md);
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            background: var(--seven-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 2.5rem;
            color: white;
            animation: pop 0.4s ease;
        }
        
        @keyframes pop {
            0% { transform: scale(0); }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-stripes">
            <div class="stripe-orange"></div>
            <div class="stripe-green"></div>
            <div class="stripe-red"></div>
        </div>
        <div class="header-content">
            <span class="header-back" onclick="location.href='/'">â†</span>
            <h1>ğŸ“± å¿«é€Ÿå•†å“ç™»è¨˜</h1>
            <p class="subtitle">æƒæ¢ç¢¼ â†’ é¸æ•ˆæœŸ â†’ å®Œæˆï¼</p>
        </div>
    </header>

    <div class="container">
        
        <!-- æ­¥é©Ÿä¸€ï¼šæƒææ¢ç¢¼ -->
        <div id="step1">
            <div class="settings-section">
                <h3>1ï¸âƒ£ æƒææˆ–è¼¸å…¥æ¢ç¢¼</h3>
                
                <!-- ç›¸æ©Ÿæƒæå€åŸŸ -->
                <div id="scannerContainer" class="scanner-container hidden">
                    <div id="scanner"></div>
                    <button class="btn btn-secondary" id="closeScannerBtn" style="margin-top: 10px;">
                        âœ• é—œé–‰ç›¸æ©Ÿ
                    </button>
                </div>
                
                <div class="form-group">
                    <div class="barcode-input-wrapper">
                        <input type="text" id="barcodeInput" 
                               placeholder="ç”¨æƒæå™¨æƒï½æˆ–æ‰‹å‹•è¼¸å…¥" 
                               inputmode="numeric" 
                               autofocus>
                        <span class="scan-icon" id="openScannerBtn" style="cursor: pointer;">ğŸ“·</span>
                    </div>
                    <p class="helper-text">é» ğŸ“· é–‹ç›¸æ©Ÿæƒæ¢ç¢¼ï¼Œæˆ–ç”¨æƒæå™¨ç›´æ¥æƒï¼</p>
                </div>
                
                <button class="btn btn-primary" id="lookupBtn">
                    ğŸ” æŸ¥è©¢å•†å“
                </button>
            </div>
            
            <div class="camera-tips" style="margin-top: 16px;">
                <h4>ğŸ’¡ å°æç¤º</h4>
                <ul>
                    <li>é» ğŸ“· å¯ä»¥é–‹ç›¸æ©Ÿæƒæ¢ç¢¼</li>
                    <li>ç”¨è—ç‰™æƒæå™¨æ›´å¿«</li>
                    <li>æˆ–è€…ç›´æ¥æ‰‹æ‰“æ¢ç¢¼æ•¸å­—</li>
                </ul>
            </div>
        </div>

        <!-- æ­¥é©ŸäºŒAï¼šæ‰¾åˆ°å•†å“ï¼ˆå•†å“è¨˜æ†¶ç”Ÿæ•ˆï¼ï¼‰ -->
        <div id="step2a" class="hidden">
            <div class="product-found">
                <div class="product-found-icon">ğŸ’¡</div>
                <p class="product-found-name" id="foundName">å…‰æ³‰é®®ä¹³</p>
                <p class="product-found-info" id="foundInfo">æ¢ç¢¼ï¼š4710043100123 Â· å†·è—</p>
            </div>
            
            <div class="settings-section">
                <h3>2ï¸âƒ£ é¸æ“‡æ•ˆæœŸ</h3>
                
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 12px;">
                    å¿«é€Ÿé¸æ“‡ ğŸ‘‡
                </p>
                <div class="expiry-shortcuts">
                    <button class="expiry-shortcut" data-days="1">æ˜å¤©</button>
                    <button class="expiry-shortcut" data-days="2">å¾Œå¤©</button>
                    <button class="expiry-shortcut" data-days="3">3å¤©å¾Œ</button>
                    <button class="expiry-shortcut" data-days="5">5å¤©å¾Œ</button>
                    <button class="expiry-shortcut" data-days="7">7å¤©å¾Œ</button>
                </div>
                
                <div class="form-group">
                    <label>æˆ–æ‰‹å‹•é¸æ—¥æœŸ</label>
                    <input type="datetime-local" id="expiryInput2a">
                </div>
                
                <h3 style="margin-top: 20px;">3ï¸âƒ£ æ•¸é‡</h3>
                <div class="quantity-big">
                    <button class="qty-btn" id="qtyMinus2a">âˆ’</button>
                    <span class="qty-display" id="qtyDisplay2a">1</span>
                    <button class="qty-btn" id="qtyPlus2a">+</button>
                </div>
                
                <button class="btn btn-success btn-lg mt-24" id="confirmBtn2a">
                    âœ… ç¢ºèªç™»è¨˜
                </button>
                
                <button class="btn btn-secondary mt-16" id="backBtn2a">
                    â† é‡æ–°æƒæ
                </button>
            </div>
        </div>

        <!-- æ­¥é©ŸäºŒBï¼šæ–°å•†å“ï¼ˆç¬¬ä¸€æ¬¡ç™»è¨˜ï¼‰ -->
        <div id="step2b" class="hidden">
            <div class="product-new">
                <div class="product-new-icon">âœ¨</div>
                <p class="product-new-title">æ–°å•†å“ï¼ç¬¬ä¸€æ¬¡ç™»è¨˜</p>
                <p class="product-new-info">æ¢ç¢¼ï¼š<span id="newBarcode">4710043100123</span></p>
            </div>
            
            <div class="settings-section">
                <h3>2ï¸âƒ£ å¡«å¯«å•†å“è³‡æ–™</h3>
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 16px;">
                    åªè¦å¡«ä¸€æ¬¡ï¼Œä¸‹æ¬¡æƒåˆ°å°±æœƒè‡ªå‹•å¸¶å…¥å›‰ï¼
                </p>
                
                <div class="form-group">
                    <label>å•†å“åç¨± *</label>
                    <input type="text" id="newName" placeholder="ä¾‹å¦‚ï¼šå…‰æ³‰é®®ä¹³ã€å¾¡é£¯ç³°é®ªé­š">
                </div>
                
                <div class="form-group">
                    <label>å•†å“é¡åˆ¥</label>
                    <div class="quick-category-grid">
                        <button class="category-btn" data-value="ä¹³è£½å“">
                            <span class="emoji">ğŸ¥›</span>ä¹³è£½å“
                        </button>
                        <button class="category-btn" data-value="æ²™æ‹‰">
                            <span class="emoji">ğŸ¥—</span>æ²™æ‹‰
                        </button>
                        <button class="category-btn" data-value="ä¸‰æ˜æ²»">
                            <span class="emoji">ğŸ¥ª</span>ä¸‰æ˜æ²»
                        </button>
                        <button class="category-btn" data-value="éºµåŒ…">
                            <span class="emoji">ğŸ</span>éºµåŒ…
                        </button>
                        <button class="category-btn" data-value="ä¾¿ç•¶">
                            <span class="emoji">ğŸ±</span>ä¾¿ç•¶
                        </button>
                        <button class="category-btn" data-value="é£²æ–™">
                            <span class="emoji">ğŸ¥¤</span>é£²æ–™
                        </button>
                        <button class="category-btn" data-value="ç”œé»">
                            <span class="emoji">ğŸ°</span>ç”œé»
                        </button>
                        <button class="category-btn" data-value="å…¶ä»–">
                            <span class="emoji">ğŸ“¦</span>å…¶ä»–
                        </button>
                    </div>
                    <input type="hidden" id="newCategory" value="">
                </div>
                
                <div class="form-group">
                    <label>å„²å­˜æº«åº¦</label>
                    <select id="newTemp">
                        <option value="refrigerated">â„ï¸ å†·è—ï¼ˆé®®å¥¶ã€æ²™æ‹‰ã€ä¾¿ç•¶ï¼‰</option>
                        <option value="frozen">ğŸ§Š å†·å‡ï¼ˆå†°æ·‡æ·‹ã€å†·å‡é£Ÿå“ï¼‰</option>
                        <option value="room_temp">ğŸŒ¡ï¸ å¸¸æº«ï¼ˆé¤…ä¹¾ã€æ³¡éºµï¼‰</option>
                    </select>
                </div>
                
                <h3 style="margin-top: 20px;">3ï¸âƒ£ æ•ˆæœŸå’Œæ•¸é‡</h3>
                
                <div class="expiry-shortcuts">
                    <button class="expiry-shortcut" data-days="1">æ˜å¤©</button>
                    <button class="expiry-shortcut" data-days="2">å¾Œå¤©</button>
                    <button class="expiry-shortcut" data-days="3">3å¤©å¾Œ</button>
                    <button class="expiry-shortcut" data-days="5">5å¤©å¾Œ</button>
                    <button class="expiry-shortcut" data-days="7">7å¤©å¾Œ</button>
                </div>
                
                <div class="form-group">
                    <input type="datetime-local" id="expiryInput2b">
                </div>
                
                <div class="quantity-big">
                    <button class="qty-btn" id="qtyMinus2b">âˆ’</button>
                    <span class="qty-display" id="qtyDisplay2b">1</span>
                    <button class="qty-btn" id="qtyPlus2b">+</button>
                </div>
                
                <button class="btn btn-success btn-lg mt-24" id="confirmBtn2b">
                    âœ… ç¢ºèªç™»è¨˜
                </button>
                
                <button class="btn btn-secondary mt-16" id="backBtn2b">
                    â† é‡æ–°æƒæ
                </button>
            </div>
        </div>

        <!-- æ­¥é©Ÿä¸‰ï¼šæˆåŠŸ -->
        <div id="step3" class="hidden">
            <div class="success-card">
                <div class="success-icon">âœ“</div>
                <h3 style="font-size: 1.25rem; color: var(--seven-green); margin-bottom: 8px;">
                    ç™»è¨˜æˆåŠŸï¼ğŸ‰
                </h3>
                <p class="text-muted" style="margin-bottom: 24px;">
                    å•†å“å·²åŠ å…¥åº«å­˜
                </p>
                
                <button class="btn btn-primary btn-lg" id="continueBtn">
                    â• ç¹¼çºŒç™»è¨˜ä¸‹ä¸€å€‹
                </button>
                
                <button class="btn btn-secondary mt-16" onclick="location.href='/inventory'">
                    ğŸ“‹ æŸ¥çœ‹åº«å­˜
                </button>
            </div>
        </div>

        <!-- ç‰ˆæ¬Š -->
        <div class="copyright">
            <p class="copyright-brand">æ½®æ¬£å°å¹«æ‰‹</p>
            <p>Â© 2026 ç‹é€¸å› ç‰ˆæ¬Šæ‰€æœ‰</p>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
        // ===== å…ƒç´  =====
        const step1 = document.getElementById('step1');
        const step2a = document.getElementById('step2a');
        const step2b = document.getElementById('step2b');
        const step3 = document.getElementById('step3');
        
        const barcodeInput = document.getElementById('barcodeInput');
        
        let currentBarcode = '';
        let currentProduct = null;
        let quantity2a = 1;
        let quantity2b = 1;
        
        // ===== ç›¸æ©ŸæƒæåŠŸèƒ½ =====
        let html5QrCode = null;
        const scannerContainer = document.getElementById('scannerContainer');
        const openScannerBtn = document.getElementById('openScannerBtn');
        const closeScannerBtn = document.getElementById('closeScannerBtn');
        
        // æª¢æŸ¥ç›¸æ©Ÿæ˜¯å¦å¯ç”¨
        async function checkCameraAvailable() {
            try {
                // æª¢æŸ¥æ˜¯å¦æ”¯æ´ mediaDevices
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    return { available: false, reason: 'ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©ŸåŠŸèƒ½' };
                }
                
                // æª¢æŸ¥æ˜¯å¦æœ‰ç›¸æ©Ÿè£ç½®
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cameras = devices.filter(d => d.kind === 'videoinput');
                
                if (cameras.length === 0) {
                    return { available: false, reason: 'æ‰¾ä¸åˆ°ç›¸æ©Ÿè£ç½®' };
                }
                
                return { available: true, cameras: cameras };
            } catch (err) {
                return { available: false, reason: err.message };
            }
        }
        
        // é–‹å•Ÿç›¸æ©Ÿ
        openScannerBtn.onclick = async () => {
            console.log('ğŸ¬ å˜—è©¦é–‹å•Ÿç›¸æ©Ÿ...');
            
            // å…ˆæª¢æŸ¥ç›¸æ©Ÿæ˜¯å¦å¯ç”¨
            const check = await checkCameraAvailable();
            if (!check.available) {
                showToast(`ğŸ˜… ${check.reason}ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æ¢ç¢¼`, 'error');
                console.error('ç›¸æ©Ÿä¸å¯ç”¨:', check.reason);
                return;
            }
            
            console.log('ğŸ“· æ‰¾åˆ°ç›¸æ©Ÿ:', check.cameras.length, 'å€‹');
            
            // é¡¯ç¤ºæƒæå€åŸŸ
            scannerContainer.classList.remove('hidden');
            
            try {
                // åˆå§‹åŒ–æƒæå™¨
                if (!html5QrCode) {
                    html5QrCode = new Html5Qrcode("scanner");
                }
                
                // å–å¾—ç›¸æ©Ÿè¨­å®š
                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 100 },
                    aspectRatio: 1.5,
                    formatsToSupport: [
                        Html5QrcodeSupportedFormats.EAN_13,
                        Html5QrcodeSupportedFormats.EAN_8,
                        Html5QrcodeSupportedFormats.UPC_A,
                        Html5QrcodeSupportedFormats.UPC_E,
                        Html5QrcodeSupportedFormats.CODE_128,
                        Html5QrcodeSupportedFormats.CODE_39
                    ]
                };
                
                // å˜—è©¦å•Ÿå‹•ç›¸æ©Ÿ
                await html5QrCode.start(
                    { facingMode: "environment" },  // å„ªå…ˆä½¿ç”¨å¾Œé¡é ­
                    config,
                    (decodedText) => {
                        // æƒææˆåŠŸï¼
                        console.log('âœ… æƒææˆåŠŸ:', decodedText);
                        barcodeInput.value = decodedText;
                        if (navigator.vibrate) navigator.vibrate(100);
                        showToast('âœ… æƒææˆåŠŸï¼', 'success');
                        stopScanner();
                        lookupBarcode();
                    },
                    (errorMessage) => {
                        // æŒçºŒæƒæä¸­ï¼Œå¿½ç•¥éŒ¯èª¤
                    }
                );
                
                console.log('ğŸ“· ç›¸æ©Ÿå·²å•Ÿå‹•');
                showToast('ğŸ“· ç›¸æ©Ÿå·²é–‹å•Ÿï¼Œå°æº–æ¢ç¢¼', 'info');
                
            } catch (err) {
                console.error('âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—:', err);
                scannerContainer.classList.add('hidden');
                
                // æ ¹æ“šéŒ¯èª¤é¡å‹çµ¦å‡ºä¸åŒæç¤º
                if (err.name === 'NotAllowedError') {
                    showToast('ğŸ˜… è«‹å…è¨±ä½¿ç”¨ç›¸æ©Ÿæ¬Šé™', 'error');
                } else if (err.name === 'NotFoundError') {
                    showToast('ğŸ˜… æ‰¾ä¸åˆ°ç›¸æ©Ÿï¼Œè«‹æ‰‹å‹•è¼¸å…¥', 'error');
                } else if (err.name === 'NotReadableError') {
                    showToast('ğŸ˜… ç›¸æ©Ÿè¢«å…¶ä»–ç¨‹å¼ä½¿ç”¨ä¸­', 'error');
                } else if (err.message && err.message.includes('HTTPS')) {
                    showToast('ğŸ˜… éœ€è¦ HTTPS æ‰èƒ½ä½¿ç”¨ç›¸æ©Ÿ', 'error');
                } else {
                    showToast(`ğŸ˜… ç›¸æ©Ÿé–‹å•Ÿå¤±æ•—ï¼š${err.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
            }
        };
        
        // é—œé–‰ç›¸æ©Ÿ
        closeScannerBtn.onclick = stopScanner;
        
        function stopScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    scannerContainer.classList.add('hidden');
                }).catch(err => console.error(err));
            } else {
                scannerContainer.classList.add('hidden');
            }
        }

        // ===== æ¢ç¢¼è¼¸å…¥ =====
        barcodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                lookupBarcode();
            }
        });
        
        // æ¢ç¢¼æƒæå™¨é€šå¸¸æœƒåœ¨æœ€å¾ŒåŠ  Enter
        let barcodeBuffer = '';
        let lastKeyTime = 0;
        
        barcodeInput.addEventListener('input', (e) => {
            const now = Date.now();
            // å¦‚æœè¼¸å…¥å¾ˆå¿«ï¼ˆæƒæå™¨ç‰¹å¾µï¼‰ï¼Œè‡ªå‹•æŸ¥è©¢
            if (now - lastKeyTime < 50 && barcodeInput.value.length >= 8) {
                clearTimeout(window.scanTimeout);
                window.scanTimeout = setTimeout(() => {
                    lookupBarcode();
                }, 200);
            }
            lastKeyTime = now;
        });
        
        document.getElementById('lookupBtn').onclick = lookupBarcode;

        // ===== æŸ¥è©¢æ¢ç¢¼ =====
        async function lookupBarcode() {
            const barcode = barcodeInput.value.trim();
            if (!barcode) {
                showToast('è«‹è¼¸å…¥æ¢ç¢¼', 'error');
                return;
            }
            
            currentBarcode = barcode;
            
            try {
                // ğŸ†• ä½¿ç”¨æ™ºæ…§æŸ¥è©¢ï¼ˆæœƒæŸ¥è©¢å¤–éƒ¨è³‡æ–™åº«ï¼‰
                const product = await smartLookupBarcode(barcode);
                
                if (product) {
                    // æ‰¾åˆ°äº†ï¼
                    currentProduct = product;
                    
                    // é¡¯ç¤ºä¾†æºæç¤º
                    const sourceName = getSourceName(product.source);
                    if (product.source !== 'local') {
                        showToast(`âœ¨ å¾ ${sourceName} æ‰¾åˆ°å•†å“è³‡æ–™ï¼`, 'success');
                        
                        // å¤–éƒ¨è³‡æ–™åº«æ‰¾åˆ°çš„ï¼Œå…ˆå»ºç«‹æœ¬åœ°å•†å“è¨˜éŒ„
                        const result = await api('/products', {
                            method: 'POST',
                            body: JSON.stringify({
                                barcode: barcode,
                                name: product.name,
                                category: product.category || null,
                                storage_temp: product.storage_temp || 'refrigerated'
                            })
                        });
                        currentProduct.id = result.id;
                        currentProduct.product_id = result.id;
                    } else {
                        currentProduct.id = product.product_id;
                    }
                    
                    document.getElementById('foundName').textContent = product.name;
                    document.getElementById('foundInfo').textContent = 
                        `æ¢ç¢¼ï¼š${barcode} Â· ${getTempText(product.storage_temp || 'refrigerated')}`;
                    goStep('2a');
                } else {
                    // æ–°å•†å“
                    currentProduct = null;
                    document.getElementById('newBarcode').textContent = barcode;
                    goStep('2b');
                }
            } catch (err) {
                console.error('æŸ¥è©¢å¤±æ•—:', err);
                showToast('æŸ¥è©¢å¤±æ•—', 'error');
            }
        }
        
        function getTempText(temp) {
            const map = {
                'refrigerated': 'â„ï¸ å†·è—',
                'frozen': 'ğŸ§Š å†·å‡',
                'room_temp': 'ğŸŒ¡ï¸ å¸¸æº«'
            };
            return map[temp] || 'â„ï¸ å†·è—';
        }

        // ===== æ•ˆæœŸå¿«æ·éµ =====
        document.querySelectorAll('.expiry-shortcut').forEach(btn => {
            btn.onclick = () => {
                const days = parseInt(btn.dataset.days);
                const date = new Date();
                date.setDate(date.getDate() + days);
                date.setHours(23, 59, 0, 0);
                
                const formatted = date.toISOString().slice(0, 16);
                document.getElementById('expiryInput2a').value = formatted;
                document.getElementById('expiryInput2b').value = formatted;
            };
        });

        // ===== é¡åˆ¥é¸æ“‡ =====
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                document.getElementById('newCategory').value = btn.dataset.value;
            };
        });

        // ===== æ•¸é‡æ§åˆ¶ - 2a =====
        document.getElementById('qtyMinus2a').onclick = () => {
            if (quantity2a > 1) {
                quantity2a--;
                document.getElementById('qtyDisplay2a').textContent = quantity2a;
            }
        };
        document.getElementById('qtyPlus2a').onclick = () => {
            if (quantity2a < 99) {
                quantity2a++;
                document.getElementById('qtyDisplay2a').textContent = quantity2a;
            }
        };

        // ===== æ•¸é‡æ§åˆ¶ - 2b =====
        document.getElementById('qtyMinus2b').onclick = () => {
            if (quantity2b > 1) {
                quantity2b--;
                document.getElementById('qtyDisplay2b').textContent = quantity2b;
            }
        };
        document.getElementById('qtyPlus2b').onclick = () => {
            if (quantity2b < 99) {
                quantity2b++;
                document.getElementById('qtyDisplay2b').textContent = quantity2b;
            }
        };

        // ===== è¿”å› =====
        document.getElementById('backBtn2a').onclick = () => {
            resetForm();
            goStep('1');
        };
        document.getElementById('backBtn2b').onclick = () => {
            resetForm();
            goStep('1');
        };

        // ===== ç¢ºèªç™»è¨˜ - èˆŠå•†å“ =====
        document.getElementById('confirmBtn2a').onclick = async () => {
            const expiry = document.getElementById('expiryInput2a').value;
            if (!expiry) {
                showToast('è«‹é¸æ“‡æ•ˆæœŸ', 'error');
                return;
            }
            
            const btn = document.getElementById('confirmBtn2a');
            btn.disabled = true;
            btn.textContent = 'ç™»è¨˜ä¸­...';
            
            try {
                await api('/inventory', {
                    method: 'POST',
                    body: JSON.stringify({
                        product_id: currentProduct.id,
                        expiry_date: expiry,
                        quantity: quantity2a
                    })
                });
                
                if (navigator.vibrate) navigator.vibrate(100);
                showToast('ğŸ‰ ç™»è¨˜æˆåŠŸï¼', 'success');
                goStep('3');
            } catch (err) {
                showToast(err.message || 'ç™»è¨˜å¤±æ•—', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'âœ… ç¢ºèªç™»è¨˜';
            }
        };

        // ===== ç¢ºèªç™»è¨˜ - æ–°å•†å“ =====
        document.getElementById('confirmBtn2b').onclick = async () => {
            const name = document.getElementById('newName').value.trim();
            const category = document.getElementById('newCategory').value;
            const temp = document.getElementById('newTemp').value;
            const expiry = document.getElementById('expiryInput2b').value;
            
            if (!name) {
                showToast('è«‹è¼¸å…¥å•†å“åç¨±', 'error');
                document.getElementById('newName').focus();
                return;
            }
            if (!expiry) {
                showToast('è«‹é¸æ“‡æ•ˆæœŸ', 'error');
                return;
            }
            
            const btn = document.getElementById('confirmBtn2b');
            btn.disabled = true;
            btn.textContent = 'ç™»è¨˜ä¸­...';
            
            try {
                // å…ˆå»ºç«‹å•†å“
                const product = await api('/products', {
                    method: 'POST',
                    body: JSON.stringify({
                        barcode: currentBarcode,
                        name: name,
                        category: category || null,
                        storage_temp: temp
                    })
                });
                
                // å†å»ºç«‹åº«å­˜
                await api('/inventory', {
                    method: 'POST',
                    body: JSON.stringify({
                        product_id: product.id,
                        expiry_date: expiry,
                        quantity: quantity2b
                    })
                });
                
                if (navigator.vibrate) navigator.vibrate(100);
                showToast('ğŸ‰ ç™»è¨˜æˆåŠŸï¼å•†å“å·²è¨˜ä½å›‰', 'success');
                goStep('3');
            } catch (err) {
                showToast(err.message || 'ç™»è¨˜å¤±æ•—', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'âœ… ç¢ºèªç™»è¨˜';
            }
        };

        // ===== ç¹¼çºŒç™»è¨˜ =====
        document.getElementById('continueBtn').onclick = () => {
            resetForm();
            goStep('1');
        };

        // ===== é‡ç½®è¡¨å–® =====
        function resetForm() {
            stopScanner();  // é—œé–‰ç›¸æ©Ÿ
            barcodeInput.value = '';
            document.getElementById('newName').value = '';
            document.getElementById('newCategory').value = '';
            document.getElementById('newTemp').value = 'refrigerated';
            document.getElementById('expiryInput2a').value = '';
            document.getElementById('expiryInput2b').value = '';
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('selected'));
            quantity2a = 1;
            quantity2b = 1;
            document.getElementById('qtyDisplay2a').textContent = '1';
            document.getElementById('qtyDisplay2b').textContent = '1';
            currentBarcode = '';
            currentProduct = null;
            barcodeInput.focus();
        }

        // ===== åˆ‡æ›æ­¥é©Ÿ =====
        function goStep(step) {
            if (step !== '1') stopScanner();  // é›¢é–‹æ­¥é©Ÿ1æ™‚é—œé–‰ç›¸æ©Ÿ
            
            step1.classList.toggle('hidden', step !== '1');
            step2a.classList.toggle('hidden', step !== '2a');
            step2b.classList.toggle('hidden', step !== '2b');
            step3.classList.toggle('hidden', step !== '3');
            
            if (step === '1') {
                setTimeout(() => barcodeInput.focus(), 100);
            }
        }

        // é é¢è¼‰å…¥æ™‚ focus
        setTimeout(() => barcodeInput.focus(), 100);
    </script>
</body>
</html>
