<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“¢ åº—é•·å…¬å‘Š - æ½®æ¬£å°å¹«æ‰‹</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .announcement-container { max-width: 600px; margin: 0 auto; padding: 15px; }
        
        .current-announcement {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            border-radius: 15px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }
        .current-announcement h3 { margin: 0 0 10px 0; font-size: 16px; opacity: 0.9; }
        .current-announcement .content { 
            font-size: 18px; 
            line-height: 1.6; 
            word-break: break-word;
            white-space: pre-wrap;
        }
        .current-announcement .meta { 
            margin-top: 15px; 
            font-size: 12px; 
            opacity: 0.8; 
            display: flex;
            justify-content: space-between;
        }
        .no-announcement {
            background: #f5f5f5;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            color: #999;
        }
        
        .edit-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .edit-section h3 { margin: 0 0 15px 0; font-size: 16px; color: #333; }
        
        .announcement-input {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 16px;
            resize: vertical;
            box-sizing: border-box;
            font-family: inherit;
            line-height: 1.5;
        }
        .announcement-input:focus {
            border-color: #FF6B35;
            outline: none;
        }
        .announcement-input::placeholder { color: #bbb; }
        
        .char-count {
            text-align: right;
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        .char-count.warning { color: #f44336; }
        
        .btn-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-primary { background: #FF6B35; color: white; }
        .btn-primary:disabled { background: #ccc; }
        .btn-danger { background: #f44336; color: white; }
        .btn-secondary { background: #eee; color: #666; }
        
        .quick-templates {
            margin-top: 15px;
        }
        .quick-templates h4 { font-size: 13px; color: #666; margin: 0 0 10px 0; }
        .template-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .template-chip {
            padding: 6px 12px;
            background: #f0f0f0;
            border: none;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .template-chip:hover { background: #FFE0D0; color: #FF6B35; }
        
        .history-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .history-section h3 { margin: 0 0 15px 0; font-size: 16px; color: #333; }
        .history-list { max-height: 300px; overflow-y: auto; }
        .history-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .history-item:last-child { border-bottom: none; }
        .history-item .content { color: #333; margin-bottom: 5px; white-space: pre-wrap; }
        .history-item .meta { color: #999; font-size: 11px; }
        .history-empty { color: #999; text-align: center; padding: 20px; }
        
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>
    <div class="announcement-container">
        <header style="margin-bottom: 20px;">
            <h1 style="margin: 0; font-size: 22px;">ğŸ“¢ åº—é•·å…¬å‘Š</h1>
            <p style="color: #666; margin: 5px 0 0 0; font-size: 13px;">ç™¼å¸ƒè¨Šæ¯çµ¦æ‰€æœ‰å“¡å·¥çœ‹</p>
        </header>

        <!-- ç›®å‰å…¬å‘Š -->
        <div id="currentAnnouncement">
            <div class="no-announcement">
                <p>ğŸ“­ ç›®å‰æ²’æœ‰å…¬å‘Š</p>
            </div>
        </div>

        <!-- ç·¨è¼¯å€ -->
        <div class="edit-section">
            <h3>âœï¸ ç™¼å¸ƒæ–°å…¬å‘Š</h3>
            <textarea 
                class="announcement-input" 
                id="announcementInput" 
                placeholder="è¼¸å…¥å…¬å‘Šå…§å®¹...&#10;&#10;ä¾‹å¦‚ï¼š&#10;â€¢ ä»Šå¤©åº—é•·åˆæ²’å¸¶æ‰‹æ©Ÿå›å®¶äº† ğŸ˜…&#10;â€¢ å†·è—æ«ƒç¬¬äºŒå±¤è¦æ•´ç†&#10;â€¢ è¨˜å¾—è£œè²¨é®®å¥¶"
                maxlength="500"
            ></textarea>
            <div class="char-count" id="charCount">0 / 500</div>
            
            <div class="quick-templates">
                <h4>ğŸ’¡ å¿«é€Ÿç¯„æœ¬</h4>
                <div class="template-chips">
                    <button class="template-chip" onclick="insertTemplate('ğŸ“± åº—é•·ä»Šå¤©æ²’å¸¶æ‰‹æ©Ÿï¼Œæœ‰æ€¥äº‹è«‹æ‰“å¸‚è©±ï¼')">æ²’å¸¶æ‰‹æ©Ÿ</button>
                    <button class="template-chip" onclick="insertTemplate('ğŸ§¹ ä»Šå¤©é‡é»ï¼šå†·è—å€æ•´ç†')">å†·è—æ•´ç†</button>
                    <button class="template-chip" onclick="insertTemplate('ğŸ“¦ åˆ°è²¨æé†’ï¼šè¨˜å¾—é»æ”¶ä»Šå¤©çš„è²¨')">åˆ°è²¨æé†’</button>
                    <button class="template-chip" onclick="insertTemplate('âš ï¸ æ³¨æ„ï¼šæ•ˆæœŸå“è¦å„ªå…ˆè™•ç†ï¼')">æ•ˆæœŸæ³¨æ„</button>
                    <button class="template-chip" onclick="insertTemplate('ğŸ‰ è¾›è‹¦äº†ï¼ä»Šå¤©å¤§å®¶éƒ½å¾ˆæ£’ï½')">é¼“å‹µå¤§å®¶</button>
                    <button class="template-chip" onclick="insertTemplate('ğŸ”§ è¨­å‚™å•é¡Œï¼š')">è¨­å‚™å•é¡Œ</button>
                </div>
            </div>
            
            <div class="btn-row">
                <button class="btn btn-danger" onclick="clearAnnouncement()">ğŸ—‘ï¸ æ¸…é™¤</button>
                <button class="btn btn-primary" id="publishBtn" onclick="publishAnnouncement()">ğŸ“¢ ç™¼å¸ƒå…¬å‘Š</button>
            </div>
        </div>

        <!-- æ­·å²ç´€éŒ„ -->
        <div class="history-section">
            <h3>ğŸ“œ æ­·å²å…¬å‘Š</h3>
            <div class="history-list" id="historyList">
                <div class="history-empty">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <!-- è¿”å› -->
        <div style="text-align: center; margin: 20px 0;">
            <a href="/" style="display: inline-block; padding: 10px 25px; background: #666; color: white; text-decoration: none; border-radius: 8px;">ğŸ  è¿”å›é¦–é </a>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const input = document.getElementById('announcementInput');
        const charCount = document.getElementById('charCount');
        const publishBtn = document.getElementById('publishBtn');

        // å­—æ•¸è¨ˆç®—
        input.addEventListener('input', () => {
            const len = input.value.length;
            charCount.textContent = `${len} / 500`;
            charCount.classList.toggle('warning', len > 450);
            publishBtn.disabled = len === 0;
        });

        // è¼‰å…¥ç›®å‰å…¬å‘Š
        async function loadCurrentAnnouncement() {
            try {
                const res = await fetch('/api/announcement');
                const data = await res.json();
                
                const container = document.getElementById('currentAnnouncement');
                
                if (data && data.content) {
                    const date = new Date(data.updated_at);
                    const timeStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
                    
                    container.innerHTML = `
                        <div class="current-announcement">
                            <h3>ğŸ“¢ ç›®å‰å…¬å‘Š</h3>
                            <div class="content">${escapeHtml(data.content)}</div>
                            <div class="meta">
                                <span>ğŸ‘¤ ${data.created_by || 'åº—é•·'}</span>
                                <span>ğŸ• ${timeStr}</span>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="no-announcement">
                            <p>ğŸ“­ ç›®å‰æ²’æœ‰å…¬å‘Š</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('è¼‰å…¥å…¬å‘Šå¤±æ•—:', error);
            }
        }

        // è¼‰å…¥æ­·å²
        async function loadHistory() {
            try {
                const res = await fetch('/api/announcement/history');
                const data = await res.json();
                
                const container = document.getElementById('historyList');
                
                if (data && data.length > 0) {
                    container.innerHTML = data.map(item => {
                        const date = new Date(item.created_at);
                        const timeStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
                        return `
                            <div class="history-item">
                                <div class="content">${escapeHtml(item.content)}</div>
                                <div class="meta">${item.created_by || 'åº—é•·'} Â· ${timeStr}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div class="history-empty">é‚„æ²’æœ‰å…¬å‘Šç´€éŒ„</div>';
                }
            } catch (error) {
                console.error('è¼‰å…¥æ­·å²å¤±æ•—:', error);
            }
        }

        // ç™¼å¸ƒå…¬å‘Š
        async function publishAnnouncement() {
            const content = input.value.trim();
            if (!content) {
                showToast('è«‹è¼¸å…¥å…¬å‘Šå…§å®¹');
                return;
            }

            publishBtn.disabled = true;
            publishBtn.textContent = 'ç™¼å¸ƒä¸­...';

            try {
                const res = await fetch('/api/announcement', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, created_by: 'åº—é•·' })
                });
                const data = await res.json();

                if (data.success) {
                    showToast('âœ… å…¬å‘Šå·²ç™¼å¸ƒï¼');
                    input.value = '';
                    charCount.textContent = '0 / 500';
                    loadCurrentAnnouncement();
                    loadHistory();
                } else {
                    showToast('ç™¼å¸ƒå¤±æ•—ï¼š' + data.error);
                }
            } catch (error) {
                showToast('ç™¼å¸ƒå¤±æ•—ï¼Œè«‹é‡è©¦');
            } finally {
                publishBtn.disabled = false;
                publishBtn.textContent = 'ğŸ“¢ ç™¼å¸ƒå…¬å‘Š';
            }
        }

        // æ¸…é™¤å…¬å‘Š
        async function clearAnnouncement() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤ç›®å‰çš„å…¬å‘Šå—ï¼Ÿ')) return;

            try {
                const res = await fetch('/api/announcement', { method: 'DELETE' });
                const data = await res.json();

                if (data.success) {
                    showToast('âœ… å…¬å‘Šå·²æ¸…é™¤');
                    loadCurrentAnnouncement();
                    loadHistory();
                }
            } catch (error) {
                showToast('æ¸…é™¤å¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }

        // æ’å…¥ç¯„æœ¬
        function insertTemplate(text) {
            input.value = text;
            input.focus();
            input.dispatchEvent(new Event('input'));
        }

        // Toast æç¤º
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // HTML è·³è„«
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // åˆå§‹åŒ–
        loadCurrentAnnouncement();
        loadHistory();
    </script>
</body>
</html>
