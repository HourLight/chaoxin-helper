<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#F7941D">
    <title>å•†å“è³‡æ–™åº« - æ½®æ¬£å°å¹«æ‰‹</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .product-card {
            background: var(--white);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 14px;
        }
        
        .product-card .emoji {
            font-size: 2rem;
            width: 50px;
            height: 50px;
            background: var(--gray-100);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .product-card .info {
            flex: 1;
        }
        
        .product-card .name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
        }
        
        .product-card .detail {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .product-card .delete-btn {
            padding: 8px;
            border: none;
            background: none;
            font-size: 1.25rem;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        
        .product-card .delete-btn:hover {
            opacity: 1;
        }
        
        .add-product-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--seven-orange) 0%, #FF9D45 100%);
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(247, 148, 29, 0.4);
            transition: all 0.2s;
        }
        
        .add-product-btn:hover {
            transform: scale(1.1);
        }
        
        .stats-bar {
            background: var(--white);
            padding: 16px;
            border-radius: var(--radius-md);
            margin-bottom: 16px;
            text-align: center;
            box-shadow: var(--shadow-sm);
        }
        
        .stats-bar .number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--seven-orange);
        }
        
        .stats-bar .label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .search-box {
            background: var(--white);
            padding: 4px;
            border-radius: var(--radius-md);
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }
        
        .search-box input {
            border: none;
            padding: 14px 16px;
            width: 100%;
            font-size: 1rem;
            background: transparent;
        }
        
        .search-box input:focus {
            outline: none;
        }
        
        .category-filter {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
            margin-bottom: 16px;
        }
        
        .category-filter::-webkit-scrollbar {
            display: none;
        }
        
        .filter-chip {
            padding: 8px 16px;
            border-radius: 20px;
            background: var(--white);
            border: 2px solid var(--gray-300);
            font-size: 0.85rem;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-chip:hover {
            border-color: var(--seven-orange);
        }
        
        .filter-chip.active {
            background: var(--seven-orange);
            border-color: var(--seven-orange);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-stripes">
            <div class="stripe-orange"></div>
            <div class="stripe-green"></div>
            <div class="stripe-red"></div>
        </div>
        <div class="header-content">
            <span class="header-back" onclick="location.href='/'">â†</span>
            <h1>ğŸ“¦ å•†å“è³‡æ–™åº«</h1>
            <p class="subtitle">ç®¡ç†æ‰€æœ‰å•†å“è³‡æ–™</p>
        </div>
    </header>

    <div class="container" style="padding-bottom: 100px;">
        
        <!-- çµ±è¨ˆ -->
        <div class="stats-bar">
            <div class="number" id="totalCount">0</div>
            <div class="label">å€‹å•†å“å·²å»ºæª”</div>
        </div>
        
        <!-- æœå°‹ -->
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹å•†å“åç¨±æˆ–æ¢ç¢¼...">
        </div>
        
        <!-- é¡åˆ¥ç¯©é¸ -->
        <div class="category-filter">
            <button class="filter-chip active" data-filter="all">å…¨éƒ¨</button>
            <button class="filter-chip" data-filter="ä¹³è£½å“">ğŸ¥› ä¹³è£½å“</button>
            <button class="filter-chip" data-filter="æ²™æ‹‰">ğŸ¥— æ²™æ‹‰</button>
            <button class="filter-chip" data-filter="ä¸‰æ˜æ²»">ğŸ¥ª ä¸‰æ˜æ²»</button>
            <button class="filter-chip" data-filter="éºµåŒ…">ğŸ éºµåŒ…</button>
            <button class="filter-chip" data-filter="ä¾¿ç•¶">ğŸ± ä¾¿ç•¶</button>
            <button class="filter-chip" data-filter="é£²æ–™">ğŸ¥¤ é£²æ–™</button>
            <button class="filter-chip" data-filter="ç”œé»">ğŸ° ç”œé»</button>
            <button class="filter-chip" data-filter="å…¶ä»–">ğŸ“¦ å…¶ä»–</button>
        </div>
        
        <!-- å•†å“åˆ—è¡¨ -->
        <div id="productList">
            <div class="loading">
                <div class="loading-spinner"></div>
                <div class="loading-text">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
        
        <!-- ç‰ˆæ¬Š -->
        <div class="copyright">
            <p class="copyright-brand">æ½®æ¬£å°å¹«æ‰‹</p>
            <p>Â© 2026 ç‹é€¸å› ç‰ˆæ¬Šæ‰€æœ‰</p>
        </div>
    </div>
    
    <!-- æ–°å¢æŒ‰éˆ• -->
    <button class="add-product-btn" id="addBtn">+</button>

    <!-- æ–°å¢å•†å“ Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal" style="max-width: 360px;">
            <h3>â• æ–°å¢å•†å“</h3>
            <p class="text-muted" style="margin-bottom: 16px; font-size: 0.85rem;">
                å…ˆæŠŠå¸¸ç”¨å•†å“åŠ é€²ä¾†ï¼Œä¹‹å¾Œç™»è¨˜æ›´å¿«ï¼
            </p>
            
            <div class="form-group">
                <label>æ¢ç¢¼ *</label>
                <input type="text" id="addBarcode" placeholder="è¼¸å…¥æˆ–æƒææ¢ç¢¼" inputmode="numeric">
            </div>
            
            <div class="form-group">
                <label>å•†å“åç¨± *</label>
                <input type="text" id="addName" placeholder="ä¾‹å¦‚ï¼šå…‰æ³‰é®®ä¹³">
            </div>
            
            <div class="form-group">
                <label>é¡åˆ¥</label>
                <select id="addCategory">
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="ä¹³è£½å“">ğŸ¥› ä¹³è£½å“</option>
                    <option value="æ²™æ‹‰">ğŸ¥— æ²™æ‹‰</option>
                    <option value="ä¸‰æ˜æ²»">ğŸ¥ª ä¸‰æ˜æ²»</option>
                    <option value="éºµåŒ…">ğŸ éºµåŒ…</option>
                    <option value="ä¾¿ç•¶">ğŸ± ä¾¿ç•¶</option>
                    <option value="é£²æ–™">ğŸ¥¤ é£²æ–™</option>
                    <option value="ç”œé»">ğŸ° ç”œé»</option>
                    <option value="å…¶ä»–">ğŸ“¦ å…¶ä»–</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>å„²å­˜æº«åº¦</label>
                <select id="addTemp">
                    <option value="refrigerated">â„ï¸ å†·è—</option>
                    <option value="frozen">ğŸ§Š å†·å‡</option>
                    <option value="room_temp">ğŸŒ¡ï¸ å¸¸æº«</option>
                </select>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelAdd">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="confirmAdd">æ–°å¢</button>
            </div>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
        let allProducts = [];
        let currentFilter = 'all';
        let searchTerm = '';

        // è¼‰å…¥å•†å“
        async function loadProducts() {
            const list = document.getElementById('productList');
            
            try {
                const products = await api('/products');
                allProducts = products;
                document.getElementById('totalCount').textContent = products.length;
                renderProducts();
            } catch (err) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ˜¢</div>
                        <h3>è¼‰å…¥å¤±æ•—</h3>
                        <p>è«‹é‡æ–°æ•´ç†é é¢</p>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“å•†å“åˆ—è¡¨
        function renderProducts() {
            const list = document.getElementById('productList');
            
            let filtered = allProducts;
            
            // é¡åˆ¥ç¯©é¸
            if (currentFilter !== 'all') {
                filtered = filtered.filter(p => p.category === currentFilter);
            }
            
            // æœå°‹
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(p => 
                    p.name.toLowerCase().includes(term) || 
                    p.barcode.includes(term)
                );
            }
            
            if (filtered.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ“­</div>
                        <h3>æ²’æœ‰å•†å“</h3>
                        <p>é»å³ä¸‹è§’ + æ–°å¢å•†å“</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = filtered.map(p => `
                <div class="product-card">
                    <div class="emoji">${getCategoryEmoji(p.category)}</div>
                    <div class="info">
                        <div class="name">${escapeHtml(p.name)}</div>
                        <div class="detail">
                            ${p.barcode} Â· ${p.category || 'æœªåˆ†é¡'} Â· ${getTempText(p.storage_temp)}
                        </div>
                    </div>
                    <button class="delete-btn" onclick="deleteProduct(${p.id}, '${escapeHtml(p.name)}')">ğŸ—‘ï¸</button>
                </div>
            `).join('');
        }

        function getCategoryEmoji(category) {
            const map = {
                'ä¹³è£½å“': 'ğŸ¥›',
                'æ²™æ‹‰': 'ğŸ¥—',
                'ä¸‰æ˜æ²»': 'ğŸ¥ª',
                'éºµåŒ…': 'ğŸ',
                'ä¾¿ç•¶': 'ğŸ±',
                'é£²æ–™': 'ğŸ¥¤',
                'ç”œé»': 'ğŸ°',
                'å…¶ä»–': 'ğŸ“¦'
            };
            return map[category] || 'ğŸ“¦';
        }

        function getTempText(temp) {
            const map = {
                'refrigerated': 'â„ï¸ å†·è—',
                'frozen': 'ğŸ§Š å†·å‡',
                'room_temp': 'ğŸŒ¡ï¸ å¸¸æº«'
            };
            return map[temp] || 'â„ï¸ å†·è—';
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            })[m]);
        }

        // æœå°‹
        document.getElementById('searchInput').addEventListener('input', (e) => {
            searchTerm = e.target.value;
            renderProducts();
        });

        // é¡åˆ¥ç¯©é¸
        document.querySelectorAll('.filter-chip').forEach(chip => {
            chip.onclick = () => {
                document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                currentFilter = chip.dataset.filter;
                renderProducts();
            };
        });

        // æ–°å¢ Modal
        const addModal = document.getElementById('addModal');
        
        document.getElementById('addBtn').onclick = () => {
            addModal.classList.add('show');
            document.getElementById('addBarcode').focus();
        };
        
        document.getElementById('cancelAdd').onclick = () => {
            addModal.classList.remove('show');
            clearAddForm();
        };
        
        addModal.onclick = (e) => {
            if (e.target === addModal) {
                addModal.classList.remove('show');
                clearAddForm();
            }
        };

        function clearAddForm() {
            document.getElementById('addBarcode').value = '';
            document.getElementById('addName').value = '';
            document.getElementById('addCategory').value = '';
            document.getElementById('addTemp').value = 'refrigerated';
        }

        // æ–°å¢å•†å“
        document.getElementById('confirmAdd').onclick = async () => {
            const barcode = document.getElementById('addBarcode').value.trim();
            const name = document.getElementById('addName').value.trim();
            const category = document.getElementById('addCategory').value;
            const temp = document.getElementById('addTemp').value;
            
            if (!barcode || !name) {
                showToast('è«‹å¡«å¯«æ¢ç¢¼å’Œå•†å“åç¨±', 'error');
                return;
            }
            
            try {
                await api('/products', {
                    method: 'POST',
                    body: JSON.stringify({
                        barcode,
                        name,
                        category: category || null,
                        storage_temp: temp
                    })
                });
                
                showToast('âœ… å•†å“æ–°å¢æˆåŠŸï¼', 'success');
                addModal.classList.remove('show');
                clearAddForm();
                loadProducts();
            } catch (err) {
                showToast(err.message || 'æ–°å¢å¤±æ•—', 'error');
            }
        };

        // åˆªé™¤å•†å“
        async function deleteProduct(id, name) {
            const confirmed = await showConfirm('åˆªé™¤å•†å“', `ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€å—ï¼Ÿ`);
            if (!confirmed) return;
            
            try {
                await api(`/products/${id}`, { method: 'DELETE' });
                showToast('âœ… å·²åˆªé™¤', 'success');
                loadProducts();
            } catch (err) {
                showToast('åˆªé™¤å¤±æ•—', 'error');
            }
        }

        loadProducts();
    </script>
</body>
</html>
