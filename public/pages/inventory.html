<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#F7941D">
    <title>åº«å­˜ç®¡ç† - æ½®æ¬£å°å¹«æ‰‹</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- 7-11 é¢¨æ ¼ Header -->
    <header class="header">
        <div class="header-stripes">
            <div class="stripe-orange"></div>
            <div class="stripe-green"></div>
            <div class="stripe-red"></div>
        </div>
        <div class="header-content">
            <span class="header-back" onclick="location.href='/'">â†</span>
            <h1>ğŸ“‹ åº«å­˜ç®¡ç†</h1>
            <p class="subtitle">ç®¡ç†æ•ˆæœŸã€ä¸‹æ¶è™•ç†</p>
        </div>
    </header>
<!-- 
  ğŸ“ é€™æ®µç¨‹å¼ç¢¼è¦åŠ å…¥ public/pages/inventory.html
  ğŸ“ ä½ç½®ï¼šåœ¨é é¢æ¨™é¡Œå€å¡Šé™„è¿‘ï¼Œé€šå¸¸åœ¨ <h1> æˆ– header å¾Œé¢
-->

<!-- ========== ç®¡ç†å“¡æ•ˆæœŸç¢ºèªæé†’å€å¡Š ========== -->
<div id="admin-notify-section" style="
    background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
">
    <div style="color: white;">
        <div style="font-size: 18px; font-weight: bold; margin-bottom: 4px;">
            ğŸ”” æ•ˆæœŸç¢ºèªæé†’
        </div>
        <div style="font-size: 13px; opacity: 0.9;">
            é€šçŸ¥åŒä»ç¢ºèªå•†å“æ•ˆæœŸï¼ˆå¯èƒ½éæœŸæˆ–ç™»è¨˜éŒ¯èª¤ï¼‰
        </div>
    </div>
    <button id="btn-notify-now" onclick="sendNotifyNow()" style="
        background: white;
        color: #FF6B35;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 15px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    ">
        ğŸ“¢ ç«‹å³ç¢ºèªæ•ˆæœŸ
    </button>
</div>

<!-- ========== è¨ºæ–·å·¥å…·å€å¡Šï¼ˆå¯é¸ï¼‰ ========== -->
<div id="admin-tools-section" style="
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
">
    <div style="font-size: 14px; font-weight: bold; color: #495057; margin-bottom: 12px;">
        ğŸ› ï¸ è¨ºæ–·å·¥å…·
    </div>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button onclick="checkInventoryStatus()" style="
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
        ">ğŸ” æª¢æŸ¥åº«å­˜ç‹€æ…‹</button>
        
        <button onclick="checkLineStatus()" style="
            background: #00B900;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
        ">ğŸ’¬ æª¢æŸ¥ LINE è¨­å®š</button>
        
        <button onclick="testLineMessage()" style="
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
        ">ğŸ§ª ç™¼é€æ¸¬è©¦è¨Šæ¯</button>
    </div>
    <div id="diagnostic-result" style="
        margin-top: 12px;
        padding: 12px;
        background: white;
        border-radius: 8px;
        font-size: 13px;
        display: none;
        white-space: pre-wrap;
        font-family: monospace;
        max-height: 300px;
        overflow-y: auto;
    "></div>
</div>

<!-- ========== JavaScript å‡½æ•¸ ========== -->
<script>
// ç™¼é€æé†’ä¸‹æ¶
async function sendNotifyNow() {
    const btn = document.getElementById('btn-notify-now');
    const originalText = btn.innerHTML;
    
    try {
        btn.innerHTML = 'â³ ç™¼é€ä¸­...';
        btn.disabled = true;
        btn.style.opacity = '0.7';
        
        const response = await fetch('/api/notify/manual');
        const result = await response.json();
        
        if (result.error) {
            throw new Error(result.error + (result.details ? `: ${result.details}` : ''));
        }
        
        // æˆåŠŸ
        btn.innerHTML = 'âœ… å·²ç™¼é€ï¼';
        btn.style.background = '#00A859';
        btn.style.color = 'white';
        
        // é¡¯ç¤ºçµæœ
        if (result.count > 0) {
            alert(`âœ… å·²ç™¼é€ ${result.count} å€‹å•†å“çš„æ•ˆæœŸç¢ºèªæé†’ï¼\n\nè«‹åŒä»ç¢ºèªï¼š\nâ€¢ å•†å“æ˜¯å¦çœŸçš„åˆ°æœŸéœ€è™•ç†\nâ€¢ æˆ–æ˜¯ç™»è¨˜æ™‚æ•ˆæœŸè¼¸å…¥éŒ¯èª¤éœ€ä¿®æ­£`);
        } else {
            alert('ğŸ“‹ ç›®å‰æ²’æœ‰éœ€è¦ç¢ºèªæ•ˆæœŸçš„å•†å“');
        }
        
        // 3 ç§’å¾Œæ¢å¾©æŒ‰éˆ•
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.style.background = 'white';
            btn.style.color = '#FF6B35';
            btn.disabled = false;
            btn.style.opacity = '1';
        }, 3000);
        
    } catch (error) {
        console.error('ç™¼é€æé†’å¤±æ•—:', error);
        btn.innerHTML = 'âŒ ç™¼é€å¤±æ•—';
        btn.style.background = '#dc3545';
        btn.style.color = 'white';
        
        alert('ç™¼é€å¤±æ•—ï¼š' + error.message);
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.style.background = 'white';
            btn.style.color = '#FF6B35';
            btn.disabled = false;
            btn.style.opacity = '1';
        }, 3000);
    }
}

// æª¢æŸ¥åº«å­˜ç‹€æ…‹
async function checkInventoryStatus() {
    const resultDiv = document.getElementById('diagnostic-result');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = 'ğŸ” æª¢æŸ¥ä¸­...';
    
    try {
        const response = await fetch('/api/notify/check');
        const result = await response.json();
        
        let html = `ğŸ“Š ä¼ºæœå™¨æ™‚é–“ï¼ˆå°ç£ï¼‰ï¼š${result.server_time_tw}\n\n`;
        html += `ğŸ“¦ åº«å­˜çµ±è¨ˆï¼š\n`;
        html += `   ç¸½åœ¨åº«ï¼š${result.summary.total_in_stock} ä»¶\n`;
        html += `   å·²éæœŸï¼š${result.summary.expired} ä»¶ ğŸ”´\n`;
        html += `   ä»Šå¤©åˆ°æœŸï¼š${result.summary.today} ä»¶ ğŸŸ \n`;
        html += `   æ˜å¤©åˆ°æœŸï¼š${result.summary.tomorrow} ä»¶ ğŸŸ¡\n`;
        html += `   3å¤©å…§åˆ°æœŸï¼š${result.summary.within_3_days} ä»¶\n\n`;
        html += `ğŸ“‹ å•†å“åˆ—è¡¨ï¼š\n`;
        
        result.items.forEach((item, i) => {
            const emoji = item.diff_days < 0 ? 'ğŸ”´' : 
                         item.diff_days === 0 ? 'ğŸŸ ' : 
                         item.diff_days === 1 ? 'ğŸŸ¡' : 'ğŸŸ¢';
            html += `${i+1}. ${emoji} ${item.name} - ${item.status_text}\n`;
        });
        
        resultDiv.innerHTML = html;
    } catch (error) {
        resultDiv.innerHTML = 'âŒ æª¢æŸ¥å¤±æ•—ï¼š' + error.message;
    }
}

// æª¢æŸ¥ LINE è¨­å®š
async function checkLineStatus() {
    const resultDiv = document.getElementById('diagnostic-result');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = 'ğŸ” æª¢æŸ¥ä¸­...';
    
    try {
        const response = await fetch('/api/notify/line-status');
        const result = await response.json();
        
        let html = `ğŸ’¬ LINE Bot è¨­å®šç‹€æ…‹ï¼š\n\n`;
        html += `ğŸ”§ LINE Botï¼š\n`;
        html += `   è¨­å®šå­˜åœ¨ï¼š${result.line_bot.has_settings ? 'âœ…' : 'âŒ'}\n`;
        html += `   ç¾¤çµ„ IDï¼š${result.line_bot.has_group_id ? 'âœ…' : 'âŒ'}\n`;
        html += `   Client åˆå§‹åŒ–ï¼š${result.line_bot.has_client ? 'âœ…' : 'âŒ'}\n\n`;
        html += `ğŸ”‘ ç’°å¢ƒè®Šæ•¸ï¼š\n`;
        html += `   LINE_GROUP_IDï¼š${result.env_vars.LINE_GROUP_ID}\n`;
        html += `   LINE_CHANNEL_ACCESS_TOKENï¼š${result.env_vars.LINE_CHANNEL_ACCESS_TOKEN}\n`;
        html += `   LINE_CHANNEL_SECRETï¼š${result.env_vars.LINE_CHANNEL_SECRET}\n\n`;
        html += `âš™ï¸ é€šçŸ¥è¨­å®šï¼š\n`;
        html += `   å•Ÿç”¨é€šçŸ¥ï¼š${result.notification_settings.enabled === 'true' ? 'âœ… æ˜¯' : 'âŒ å¦'}\n`;
        html += `   æå‰æ™‚æ•¸ï¼š${result.notification_settings.hours_before} å°æ™‚\n`;
        
        resultDiv.innerHTML = html;
    } catch (error) {
        resultDiv.innerHTML = 'âŒ æª¢æŸ¥å¤±æ•—ï¼š' + error.message;
    }
}

// ç™¼é€æ¸¬è©¦è¨Šæ¯
async function testLineMessage() {
    const resultDiv = document.getElementById('diagnostic-result');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = 'ğŸ§ª ç™¼é€æ¸¬è©¦è¨Šæ¯ä¸­...';
    
    try {
        const response = await fetch('/api/notify/test-line');
        const result = await response.json();
        
        if (result.success) {
            resultDiv.innerHTML = `âœ… æ¸¬è©¦è¨Šæ¯å·²ç™¼é€ï¼\n\nè«‹æª¢æŸ¥ LINE ç¾¤çµ„æ˜¯å¦æ”¶åˆ°è¨Šæ¯ã€‚\n\nç¾¤çµ„ IDï¼š${result.group_id_preview}`;
        } else {
            resultDiv.innerHTML = `âŒ ç™¼é€å¤±æ•—ï¼š${result.error}`;
        }
    } catch (error) {
        resultDiv.innerHTML = 'âŒ ç™¼é€å¤±æ•—ï¼š' + error.message;
    }
}
</script>
    <div class="container">
        <!-- å·¥å…·åˆ— -->
        <div class="toolbar">
            <div class="filters">
                <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
                <button class="filter-btn" data-filter="refrigerated">â„ï¸ å†·è—</button>
                <button class="filter-btn" data-filter="frozen">ğŸ§Š å†·å‡</button>
                <button class="filter-btn" data-filter="room_temp">ğŸŒ¡ï¸ å¸¸æº«</button>
            </div>
            <button class="btn btn-primary btn-sm" id="notifyBtn" style="width: auto; padding: 10px 16px;">
                ğŸ”” æé†’ä¸‹æ¶
            </button>
        </div>

        <!-- åº«å­˜åˆ—è¡¨ -->
        <div class="inventory-list" id="inventoryList">
            <div class="loading">
                <div class="loading-spinner"></div>
                <div class="loading-text">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <!-- ç‰ˆæ¬Šè²æ˜ -->
        <div class="copyright">
            <p class="copyright-brand">æ½®æ¬£å°å¹«æ‰‹</p>
            <p>ä¾¿åˆ©å•†åº—ç”Ÿé®®å“æ•ˆæœŸç®¡ç†ç³»çµ±</p>
            <p class="copyright-notice">Â© 2026 ç‹é€¸å› ç‰ˆæ¬Šæ‰€æœ‰<br>æœªç¶“æˆæ¬Šç¦æ­¢è¤‡è£½ã€ä¿®æ”¹æˆ–å•†æ¥­ä½¿ç”¨</p>
            <p class="copyright-contact">æˆæ¬Šæ´½è©¢ï¼šHour Light International Co., Ltd.</p>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
        const inventoryList = document.getElementById('inventoryList');
        const filterBtns = document.querySelectorAll('.filter-btn');
        let currentFilter = 'all';

        loadInventory(inventoryList);

        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                filterBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                currentFilter = btn.dataset.filter;
                const filter = currentFilter === 'all' ? {} : { storage_temp: currentFilter };
                loadInventory(inventoryList, filter);
            });
        });

        document.getElementById('notifyBtn').addEventListener('click', sendLineNotification);
    </script>
</body>
</html>
